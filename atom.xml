<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://Zu3zz.github.io</id>
    <title>zzå¤±ä¹å›­</title>
    <updated>2019-09-10T07:35:27.272Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://Zu3zz.github.io"/>
    <link rel="self" href="https://Zu3zz.github.io/atom.xml"/>
    <subtitle>Everyone Can (Not) Comprehend.</subtitle>
    <logo>https://Zu3zz.github.io/images/avatar.png</logo>
    <icon>https://Zu3zz.github.io/favicon.ico</icon>
    <rights>All rights reserved 2019, zzå¤±ä¹å›­</rights>
    <entry>
        <title type="html"><![CDATA[Yarnç³»åˆ—----åŸºç¡€ã€ä»‹ç»ã€æµç¨‹]]></title>
        <id>https://Zu3zz.github.io/post/yarn-1</id>
        <link href="https://Zu3zz.github.io/post/yarn-1">
        </link>
        <updated>2019-09-10T07:31:48.000Z</updated>
        <summary type="html"><![CDATA[<p>ç®€å•ä»‹ç»ä¸€ä¸‹èµ„æºè°ƒåº¦å·¥å…·YARN<br>
Yet Another Resource Negotiator</p>
]]></summary>
        <content type="html"><![CDATA[<p>ç®€å•ä»‹ç»ä¸€ä¸‹èµ„æºè°ƒåº¦å·¥å…·YARN<br>
Yet Another Resource Negotiator</p>
<!-- more -->
<h1 id="yarn-äº§ç”ŸèƒŒæ™¯">YARN äº§ç”ŸèƒŒæ™¯</h1>
<ul>
<li>
<p>MapReduce1.x ==&gt; MapReduce2.x</p>
<ul>
<li>master/slave : JobTracker/TaskTracker</li>
<li>JobTrackerï¼šå•ç‚¹ã€å‹åŠ›å¤§</li>
<li>ä»…ä»…åªèƒ½å¤Ÿæ”¯æŒ mapreduce ä½œä¸š</li>
</ul>
</li>
<li>
<p>èµ„æºåˆ©ç”¨ç‡</p>
<ul>
<li>æ‰€æœ‰çš„è®¡ç®—æ¡†æ¶è¿è¡Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œå…±äº«ä¸€ä¸ªé›†ç¾¤çš„èµ„æºï¼ŒæŒ‰éœ€åˆ†é…ï¼</li>
</ul>
</li>
</ul>
<pre><code class="language-txt">master: resource managementï¼šResourceManager (RM)
job scheduling/monitoringï¼šper-application ApplicationMaster (AM)
slave: NodeManager (NM)
</code></pre>
<h2 id="yarn-æ¶æ„">YARN æ¶æ„</h2>
<ul>
<li>Clientã€ResourceManagerã€NodeManagerã€ApplicationMaster</li>
<li>master/slave: RM/NM</li>
</ul>
<h2 id="client-å‘-rm-æäº¤ä»»åŠ¡-æ€æ­»ä»»åŠ¡ç­‰">Client: å‘ RM æäº¤ä»»åŠ¡ã€æ€æ­»ä»»åŠ¡ç­‰</h2>
<ul>
<li>
<p>ApplicationMasterï¼š</p>
<ul>
<li>æ¯ä¸ªåº”ç”¨ç¨‹åºå¯¹åº”ä¸€ä¸ª AM</li>
<li>AM å‘ RM ç”³è¯·èµ„æºç”¨äºåœ¨ NM ä¸Šå¯åŠ¨å¯¹åº”çš„ Task</li>
<li>æ•°æ®åˆ‡åˆ†</li>
<li>ä¸ºæ¯ä¸ª task å‘ RM ç”³è¯·èµ„æºï¼ˆcontainerï¼‰</li>
<li>NodeManager é€šä¿¡</li>
<li>ä»»åŠ¡çš„ç›‘æ§</li>
</ul>
</li>
<li>
<p>NodeManagerï¼š å¤šä¸ª</p>
<ul>
<li>å¹²æ´»</li>
<li>å‘ RM å‘é€å¿ƒè·³ä¿¡æ¯ã€ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µ</li>
<li>æ¥æ”¶æ¥è‡ª RM çš„è¯·æ±‚æ¥å¯åŠ¨ä»»åŠ¡</li>
<li>å¤„ç†æ¥è‡ª AM çš„å‘½ä»¤</li>
</ul>
</li>
<li>
<p>ResourceManager:é›†ç¾¤ä¸­åŒä¸€æ—¶åˆ»å¯¹å¤–æä¾›æœåŠ¡çš„åªæœ‰ 1 ä¸ªï¼Œè´Ÿè´£èµ„æºç›¸å…³</p>
<ul>
<li>å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼šæäº¤ã€æ€æ­»</li>
<li>å¯åŠ¨/ç›‘æ§ AM</li>
<li>ç›‘æ§ NM</li>
<li>èµ„æºç›¸å…³</li>
</ul>
</li>
<li>
<p>containerï¼šä»»åŠ¡çš„è¿è¡ŒæŠ½è±¡</p>
<ul>
<li>memoryã€cpu....</li>
<li>task æ˜¯è¿è¡Œåœ¨ container é‡Œé¢çš„</li>
<li>å¯ä»¥è¿è¡Œ amã€ä¹Ÿå¯ä»¥è¿è¡Œ map/reduce task</li>
</ul>
</li>
</ul>
<h2 id="yarn-æ‰§è¡Œæµç¨‹">yarn æ‰§è¡Œæµç¨‹</h2>
<p><img src="https://Zu3zz.github.io/post-images/1568100871914.png" alt="yarnæ‰§è¡Œæµç¨‹"></p>
<h2 id="æäº¤è‡ªå·±å¼€å‘çš„-mr-ä½œä¸šåˆ°-yarn-ä¸Šè¿è¡Œçš„æ­¥éª¤">æäº¤è‡ªå·±å¼€å‘çš„ MR ä½œä¸šåˆ° YARN ä¸Šè¿è¡Œçš„æ­¥éª¤ï¼š</h2>
<ol>
<li>mvn clean package -DskipTests æ‰“åŒ… jar åŒ…<br>
windows/Mac/Linux ==&gt; Maven</li>
<li>æŠŠç¼–è¯‘å‡ºæ¥çš„ jar åŒ…(é¡¹ç›®æ ¹ç›®å½•/target/...jar)ä»¥åŠæµ‹è¯•æ•°æ®ä¸Šä¼ åˆ°æœåŠ¡å™¨<br>
scp xxxx hadoop@hostname:directory</li>
<li>æŠŠæ•°æ®ä¸Šä¼ åˆ° HDFS<br>
hadoop fs -put xxx hdfspath</li>
<li>æ‰§è¡Œä½œä¸š<br>
hadoop jar xxx.jar å®Œæ•´çš„ç±»å(åŒ…å+ç±»å) args.....</li>
<li>åˆ° YARN UI(8088) ä¸Šå»è§‚å¯Ÿä½œä¸šçš„è¿è¡Œæƒ…å†µ</li>
<li>åˆ°è¾“å‡ºç›®å½•å»æŸ¥çœ‹å¯¹åº”çš„è¾“å‡ºç»“æœ</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hadoop()----å¤šé›†ç¾¤é…ç½®æµç¨‹]]></title>
        <id>https://Zu3zz.github.io/post/hadoop-4</id>
        <link href="https://Zu3zz.github.io/post/hadoop-4">
        </link>
        <updated>2019-09-09T13:12:27.000Z</updated>
        <summary type="html"><![CDATA[<p>ç»ˆäºåˆ°äº†æ¿€åŠ¨äººå¿ƒçš„ä¼ª(åˆ’æ‰åˆ†å¸ƒå¼ç¯èŠ‚ å¦‚ä½•å°†HDFSé…ç½®åœ¨å¤šæœºå™¨çš„é›†ç¾¤ä¸Š<br>
è¿™ç¯‡æ–‡ç« ä¼šè¯¦ç»†å‘Šè¯‰ä½ ~</p>
]]></summary>
        <content type="html"><![CDATA[<p>ç»ˆäºåˆ°äº†æ¿€åŠ¨äººå¿ƒçš„ä¼ª(åˆ’æ‰åˆ†å¸ƒå¼ç¯èŠ‚ å¦‚ä½•å°†HDFSé…ç½®åœ¨å¤šæœºå™¨çš„é›†ç¾¤ä¸Š<br>
è¿™ç¯‡æ–‡ç« ä¼šè¯¦ç»†å‘Šè¯‰ä½ ~</p>
<!-- more -->
<h1 id="hadoop-é›†ç¾¤è§„åˆ’">Hadoop é›†ç¾¤è§„åˆ’</h1>
<ul>
<li>
<p>HDFS: NN DN</p>
</li>
<li>
<p>YARN: RM NM</p>
</li>
<li>
<p>hadoop000 192.168.199.234</p>
<ul>
<li>NN RM</li>
<li>DN NM</li>
</ul>
</li>
<li>
<p>hadoop001 192.168.199.235</p>
<ul>
<li>DN NM</li>
</ul>
</li>
<li>
<p>hadoop002 192.168.199.236</p>
<ul>
<li>DN NM</li>
</ul>
</li>
</ul>
<h2 id="è¯¦ç»†æ­¥éª¤">è¯¦ç»†æ­¥éª¤</h2>
<ul>
<li>
<p>å¯¹æ¯å°æœºå™¨</p>
<ul>
<li>
<p>ä¿®æ”¹ host é…ç½®</p>
<ul>
<li>
<p>åœ¨/etc/hostname ä¸‹ä¿®æ”¹ hostname(hadoop000/hadoop001/hadoop002)</p>
</li>
<li>
<p>åœ¨/etc/hosts ä¸‹ä¿®æ”¹ ip å’Œ hostname çš„æ˜ å°„å…³ç³»</p>
<ol>
<li>192.168.199.234 hadoop000</li>
<li>192.168.199.235 hadoop001</li>
<li>192.168.199.236 hadoop002</li>
<li>192.168.199.23x localhost(è¯•æœºå™¨è€Œå®š)</li>
</ol>
</li>
</ul>
</li>
<li>
<p>å‰ç½®å®‰è£… ssh è¿›è¡Œå…å¯†ç ç™»å½•æ“ä½œ</p>
</li>
</ul>
<pre><code class="language-shell">ssh-keygen -t rsa
</code></pre>
<p>åœ¨æ¯å° hadoop æœºå™¨ä¸Šè¿›è¡Œæ“ä½œ</p>
<pre><code class="language-shell">ssh-copy-id -i ~/.ssh/id_rsa.pub hadoop000
ssh-copy-id -i ~/.ssh/id_rsa.pub hadoop001
ssh-copy-id -i ~/.ssh/id_rsa.pub hadoop002
</code></pre>
<ul>
<li>
<p>å®‰è£… java jkd</p>
<ul>
<li>é¦–å…ˆåœ¨æ¯å° hadoop é›†ç¾¤æœºå™¨ä¸Šéƒ¨ç½² jdk</li>
<li>å°† jkd bin é…ç½®åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡(~/.bash_profile)</li>
<li>å°† jdk ä»¥åŠç¯å¢ƒå˜é‡é…ç½®æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šå»(start with hadoop000)</li>
</ul>
<pre><code class="language-shell">scp -r jdk1.8.0_91 hadoop@hadoop001:~/app/
scp -r jdk1.8.0_91 hadoop@hadoop002:~/app/

scp ~/.bash_profile hadoop@hadoop001:~/
scp ~/.bash_profile hadoop@hadoop002:~/
</code></pre>
</li>
<li>
<p>Hadoop éƒ¨ç½²</p>
<ul>
<li>hadoop-env.sh é…ç½®: JAVA_HOME</li>
<li>hdfs-site.xml é…ç½®:</li>
</ul>
<pre><code class="language-xml">&lt;property&gt;
  &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;
  &lt;value&gt;/home/hadoop/app/tmp/dfs/name&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;
  &lt;value&gt;/home/hadoop/app/tmp/dfs/data&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<ul>
<li>yarn-site.xml</li>
</ul>
<pre><code class="language-xml">&lt;!--åªåœ¨hadoop000æœºå™¨ä¸­è¿›è¡Œé…ç½®--&gt;
&lt;property&gt;
  &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;
  &lt;value&gt;mapreduce_shuffle&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
    &lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;
    &lt;value&gt;hadoop000&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<ul>
<li>mapred-site.xml: è¿™ä¸ªæ–‡ä»¶åªæœ‰æ¨¡æ¿ éœ€è¦è‡ªå·±åˆ›å»º</li>
</ul>
<pre><code class="language-xml">&lt;property&gt;
  &lt;name&gt;mapreduce.framework.name&lt;/name&gt;
  &lt;value&gt;yarn&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<ul>
<li>é…ç½® slaves</li>
<li>åˆ†å‘ hadoop åˆ°å…¶ä»–æœºå™¨</li>
</ul>
<pre><code class="language-shell">scp -r hadoop-2.6.0-cdh5.15.1 hadoop@hadoop001:~/app/
scp -r hadoop-2.6.0-cdh5.15.1 hadoop@hadoop002:~/app/

scp ~/.bash_profile hadoop@hadoop001:~/
scp ~/.bash_profile hadoop@hadoop002:~/
</code></pre>
<ul>
<li>NN æ ¼å¼åŒ–</li>
</ul>
<pre><code class="language-shell">hadoop namenode -format
</code></pre>
<ul>
<li>åœ¨æ¯ä¸ªæœºå™¨ä¸Šå¯åŠ¨ HDFS</li>
<li>åœ¨æ¯ä¸ªæœºå™¨ä¸Šå¯åŠ¨ YRAN</li>
</ul>
</li>
</ul>
</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hiveç³»åˆ—(2)----å†…éƒ¨è¡¨ã€å¤–éƒ¨è¡¨ã€å®æˆ˜]]></title>
        <id>https://Zu3zz.github.io/post/hive-2</id>
        <link href="https://Zu3zz.github.io/post/hive-2">
        </link>
        <updated>2019-09-09T07:48:10.000Z</updated>
        <summary type="html"><![CDATA[<p>è¿™èŠ‚å’±ä»¬æ¥ç‚¹çœŸå®çš„<br>
hiveå¦‚ä½•åˆ›å»ºè¡¨ä»¥åŠè¯»å–æ•°æ®</p>
]]></summary>
        <content type="html"><![CDATA[<p>è¿™èŠ‚å’±ä»¬æ¥ç‚¹çœŸå®çš„<br>
hiveå¦‚ä½•åˆ›å»ºè¡¨ä»¥åŠè¯»å–æ•°æ®</p>
<!-- more -->
<h1 id="hive-å¤–éƒ¨è¡¨-å†…éƒ¨è¡¨">Hive å¤–éƒ¨è¡¨ã€å†…éƒ¨è¡¨</h1>
<h2 id="å†…éƒ¨è¡¨">å†…éƒ¨è¡¨</h2>
<p>å¯ä»¥é€šè¿‡ formatted æŸ¥çœ‹è¡¨çš„å±æ€§</p>
<pre><code class="language-sql">desc formattede mp2

å¯ä»¥çœ‹åˆ°ä¸€ç³»åˆ—å±æ€§ å…¶ä¸­æœ‰å±æ€§å¦‚ä¸‹

Table Type: MANAGED_TABLE

MANAGED_TABLEå°±ä»£emp2æ˜¯ä¸€ä¸ªå†…éƒ¨è¡¨

åˆ é™¤emp2
drop table emp2;
</code></pre>
<p>åˆ é™¤è¡¨: HDFS ä¸Šçš„æ•°æ®è¢«åˆ é™¤ &amp; Meta ä¹Ÿè¢«åˆ é™¤</p>
<h2 id="å¤–éƒ¨è¡¨">å¤–éƒ¨è¡¨</h2>
<p>åˆ›å»ºå¤–éƒ¨è¡¨</p>
<pre><code class="language-sql">CREATE EXTERNNAL TABLE emp_external(
empno int,
ename string,
job string,
mgr int,
hiredate string,
sal double,
comm double,
deptno int
) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
location '/external/emp/';

æ­¤æ—¶è¡¨æ˜¯ç©ºè¡¨ è¿˜éœ€è¦åŠ è½½æ•°æ®
LOAD DATA LOCAL INPATH '/home/hadoop/data/emp.txt' ONVERWRITE INTO TABLE emp_external

æ­¤æ—¶é€šè¿‡descæŸ¥çœ‹è¡¨çš„å±æ€§
Table Type: EXTERNAL_TABLE
æ˜¯ä¸€ä¸ªå¤–éƒ¨è¡¨

drop table emp_external
</code></pre>
<p>åˆ é™¤è¡¨: HDFS ä¸Šçš„æ•°æ®ä¸è¢«åˆ é™¤ &amp; Meta ä¸Šè¢«åˆ é™¤<br>
å®‰å…¨æ€§æ›´å¥½</p>
<h2 id="åˆ†åŒºè¡¨">åˆ†åŒºè¡¨</h2>
<p>ä½¿ç”¨åˆ†åŒºè¡¨åˆ›å»º</p>
<pre><code class="language-sql">CREATE EXTERNAL TABLE track_info(
ip string,
country string,
province string,
city string,
url string,
time string,
page string
) partitioned by (day string)
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
location '/project/trackinfo/';
</code></pre>
<p>æ­¤æ—¶é€šè¿‡æ‰§è¡Œ jar åŒ…ç”Ÿæˆ ETL æ–‡ä»¶</p>
<p>å°†è¿™ä¸ªæ–‡ä»¶å­˜å‚¨åˆ° hive ä¸­</p>
<pre><code class="language-sql">LOAD DATA INPATH 'hdfs://localhost:8020/project/input/etl'
OVERWRITE INTO TABLE track_info partition(day='2013-07-21');

ç»Ÿè®¡æ€»æ•°
select count(*) from track_info where day='2013-07-21';

ç»Ÿè®¡çœä»½çš„ä¸ªæ•°
select province,count(*) from track_info where day='2013-07-21' group by province;

ä¸ºäº†æ–¹ä¾¿å±•ç¤º åˆ›å»ºä¸€å¼ è¡¨ç”¨æ¥å­˜å‚¨çœä»½çš„ä¿¡æ¯
create table track_info_province_stat(
province string,
cnt bigint
) partitioned by (day string)
row format delimited fields terminated by '\t';

é€šè¿‡sqlè¯­å¥ç›´æ¥å†™å…¥æ•°æ®
insert overwrite table track_info_province_stat partition(day='2013-07-21') select province, count(*) as cnt from track_info where day='2013-07-21' group by province;

ç»Ÿè®¡é¡µé¢è®¿é—®æƒ…å†µ
select page,count(*) from track_info where day = '2013-07-21' group by page;

åˆ›å»ºä¸€å¼ è¡¨ç”¨æ¥å­˜å‚¨é¡µé¢è®¿é—®ä¿¡æ¯
create table track_info_page_stat(
province string,
cnt bigint
) partitioned by (day string)
row format delimited fields terminated by '\t';

å†™å…¥æ•°æ®
insert overwrite table track_info_page_stat partition(day='2013-07-21') select page, count(*) as cnt from track_info where day='2013-07-21' group by page;
</code></pre>
<p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬ç»Ÿè®¡çš„æ•°æ®å·²ç»åœ¨ Hive è¡¨ track_info_province_stat<br>
è€Œä¸”è¿™ä¸ªè¡¨æ˜¯ä¸€ä¸ªåˆ†åŒºè¡¨ï¼Œåç»­ç»Ÿè®¡æŠ¥è¡¨çš„æ•°æ®å¯ä»¥ç›´æ¥ä»è¿™ä¸ªè¡¨ä¸­æŸ¥è¯¢<br>
ä¹Ÿå¯ä»¥å°† hive è¡¨çš„æ•°æ®å¯¼å‡ºåˆ° RDBMSï¼ˆsqoop<br>
æ€»ç»“ä¸€ä¸‹æ‰€æœ‰çš„æ“ä½œ</p>
<ol>
<li>ETL</li>
<li>æŠŠ ETL è¾“å‡ºçš„æ•°æ®åŠ è½½åˆ° track_info åˆ†åŒºè¡¨é‡Œ</li>
<li>å„ä¸ªç»´åº¦ç»Ÿè®¡ç»“æœçš„æ•°æ®è¾“å‡ºåˆ°å„è‡ªç»´åº¦çš„è¡¨é‡Œ ï¼ˆå¦‚ track_info_province_statï¼‰</li>
<li>å°†æ•°æ®å¯¼å‡º (optional)</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hiveç³»åˆ—(1)----æ¦‚å¿µã€éƒ¨ç½²ã€è¯­æ³•]]></title>
        <id>https://Zu3zz.github.io/post/hive-1</id>
        <link href="https://Zu3zz.github.io/post/hive-1">
        </link>
        <updated>2019-09-07T12:35:32.000Z</updated>
        <summary type="html"><![CDATA[<p>æ…¢æ…¢å­¦ä¹ è·¯ ä¸€æ­¥ä¸€è„šå°<br>
ä»Šå¤©å¸¦æ¥hiveå­¦ä¹ ç¬”è®°ç³»åˆ—çš„ç¬¬ä¸€ç¯‡</p>
]]></summary>
        <content type="html"><![CDATA[<p>æ…¢æ…¢å­¦ä¹ è·¯ ä¸€æ­¥ä¸€è„šå°<br>
ä»Šå¤©å¸¦æ¥hiveå­¦ä¹ ç¬”è®°ç³»åˆ—çš„ç¬¬ä¸€ç¯‡</p>
<!-- more -->
<h1 id="hive-ç¬”è®°">Hive ç¬”è®°</h1>
<h2 id="hive-æ¦‚å¿µ">Hive æ¦‚å¿µ</h2>
<ul>
<li>
<p>ç»Ÿä¸€å…ƒæ•°æ®ç®¡ç†:</p>
<ul>
<li>Hive æ•°æ®æ˜¯å­˜æ”¾åœ¨ HDFS</li>
<li>å…ƒæ•°æ®ä¿¡æ¯(è®°å½•æ•°æ®çš„æ•°æ®)æ˜¯å­˜æ”¾åœ¨ MySQL ä¸­</li>
<li>SQL on Hadoopï¼š Hiveã€Spark SQLã€impala....</li>
</ul>
</li>
<li>
<p>Hive ä½“ç³»æ¶æ„</p>
<ul>
<li>client: shellã€thrift/jdbc(server/jdbc)ã€WebUI(HUE/Zeppelin)</li>
<li>metastoreï¼š==&gt; MySQL<br>
databaseï¼šnameã€locationã€owner....<br>
tableï¼šnameã€locationã€ownerã€column name/type ....</li>
</ul>
</li>
<li>
<p>Hive éƒ¨ç½²</p>
<ol>
<li>ä¸‹è½½ï¼ˆå®˜ç½‘ï¼‰</li>
<li>è§£å‹åˆ°~/app</li>
<li>æ·»åŠ  HIVE_HOME åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡</li>
<li>ä¿®æ”¹é…ç½®<br>
hive-env.sh<br>
hive-site.xml</li>
<li>æ‹·è´ MySQL é©±åŠ¨åŒ… mysql-java-connector.jar åŒ…åˆ°$HIVE_HOME/lib ä¸‹</li>
<li>å‰ææ˜¯è¦å‡†å¤‡å®‰è£…ä¸€ä¸ª MySQL æ•°æ®åº“ï¼Œåˆ©ç”¨ yum install å®‰è£…ä¸€ä¸ª MySQL æ•°æ®åº“ https://www.cnblogs.com/julyme/p/5969626.html</li>
</ol>
<pre><code class="language-xml">&lt;!--hive-site.xmlé…ç½®--&gt;
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;

&lt;configuration&gt;
&lt;property&gt;
  &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;
  &lt;value&gt;jdbc:mysql://hadoop000:3306/hadoop_hive?createDatabaseIfNotExist=true&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;
  &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;
  &lt;value&gt;æˆ‘æ˜¯ç”¨æˆ·å&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;
  &lt;value&gt;æˆ‘æ˜¯å¯†ç &lt;/value&gt;
&lt;/property&gt;
&lt;/configuration&gt;
</code></pre>
</li>
</ul>
<h2 id="hive-çš„-sql-è¯­è¨€">Hive çš„ sql è¯­è¨€</h2>
<h3 id="ddl">DDL</h3>
<p>Hive Data Definition Language</p>
<pre><code class="language-shell">createã€deleteã€alter...
</code></pre>
<p>Hive æ•°æ®æŠ½è±¡/ç»“æ„:</p>
<pre><code class="language-ASCII">+-- database  HDFSä¸€ä¸ªç›®å½•
|   +-- table HDFSä¸€ä¸ªç›®å½•
    |   +-- data  æ–‡ä»¶
    |   +-- partition åˆ†åŒºè¡¨  HDFSä¸€ä¸ªæ–‡ä»¶
        |   +-- data  æ–‡ä»¶
        |   +-- bucket  åˆ†æ¡¶  HDFSä¸€ä¸ªæ–‡ä»¶
</code></pre>
<p>Hive å…·ä½“ ddl æ“ä½œ</p>
<h3 id="åˆ›å»ºæ•°æ®åº“">åˆ›å»ºæ•°æ®åº“</h3>
<pre><code class="language-sql">CREATE (DATABASE|SCHEMA) [IF NOT EXISTS] database_name
  [COMMENT database_comment]
  [LOCATION hdfs_path]
  [WITH DBPROPERTIES (property_name=property_value, ...)];

CREATE DATABASE IF NOT EXISTS hive;

CREATE DATABASE IF NOT EXISTS hive2 LOCATION '/test/location';

CREATE DATABASE IF NOT EXISTS hive3
WITH DBPROPERTIES('creator'='pk');
</code></pre>
<p>/user/hive/warehouse æ˜¯ Hive é»˜è®¤çš„å­˜å‚¨åœ¨ HDFS ä¸Šçš„è·¯å¾„</p>
<h3 id="åˆ›å»ºè¡¨">åˆ›å»ºè¡¨</h3>
<pre><code class="language-sql">CREATE TABLE emp(
empno int,
ename string,
job string,
mgr int,
hiredate string,
sal double,
comm double,
deptno int
) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t';
</code></pre>
<h3 id="è¯»å–æœ¬åœ°æ•°æ®">è¯»å–æœ¬åœ°æ•°æ®</h3>
<pre><code class="language-sql">LOAD DATA [LOCAL] INPATH 'filepath' [OVERWRITE] INTO TABLE tablename [PARTITION (partcol1=val1, partcol2=val2 ...)]

LOAD DATA LOCAL INPATH '/home/hadoop/data/emp.txt' OVERWRITE INTO TABLE emp;
</code></pre>
<p>LOCALï¼šæœ¬åœ°ç³»ç»Ÿï¼Œå¦‚æœæ²¡æœ‰ local é‚£ä¹ˆå°±æ˜¯æŒ‡çš„ HDFS çš„è·¯å¾„<br>
OVERWRITEï¼šæ˜¯å¦æ•°æ®è¦†ç›–ï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆå°±æ˜¯æ•°æ®è¿½åŠ </p>
<pre><code class="language-sql">LOAD DATA LOCAL INPATH '/home/hadoop/data/emp.txt' OVERWRITE INTO TABLE emp;

LOAD DATA INPATH 'hdfs://hadoop000:8020/data/emp.txt' INTO TABLE emp;

INSERT OVERWRITE LOCAL DIRECTORY '/tmp/hive/'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
select empno,ename,sal,deptno from emp;
</code></pre>
<h3 id="åŸºæœ¬ç»Ÿè®¡">åŸºæœ¬ç»Ÿè®¡</h3>
<pre><code class="language-sql">select * from emp where sal between 800 and 1500 (limit(5));

select * from emp where ename in ('SMITH','KING');

select * from emp where sal is (not) null;
</code></pre>
<h3 id="èšåˆæ“ä½œ">èšåˆæ“ä½œ</h3>
<p>max/min/sum/avg</p>
<pre><code class="language-sql">select count(1) from emp where deptno = 10;

select max(sal),min(sal),sum(sal),avg(sal) from emp;
</code></pre>
<h3 id="åˆ†ç»„å‡½æ•°">åˆ†ç»„å‡½æ•°</h3>
<p>group by</p>
<p>å‡ºç°åœ¨ select ä¸­çš„å­—æ®µï¼Œå¦‚æœæ²¡æœ‰å‡ºç°åœ¨èšåˆå‡½æ•°é‡Œï¼Œé‚£ä¹ˆä¸€å®šè¦å®ç°åœ¨ group by é‡Œ</p>
<pre><code class="language-sql">æ±‚æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„
select deptno, avg(sal) from emp group by deptno;

æ±‚æ¯ä¸ªéƒ¨é—¨ã€å·¥ä½œå²—ä½çš„å¹³å‡å·¥èµ„
select deptno,job,avg(sal) from emp group by deptno, job;

æ±‚æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„å¤§äº2000çš„éƒ¨é—¨
select deptno, avg(sal) avg_sal from emp group by deptno where avg_sal &gt; 2000; é”™è¯¯ï¼ï¼ï¼

group by ä¸èƒ½åŒæ—¶å’Œ where ä½¿ç”¨
åº”è¯¥ä½¿ç”¨havingæ›¿ä»£where

select deptno, avg(sal) abg_sal from emp group by deptno having avg_sal &gt; 2000;
</code></pre>
<h3 id="å¤šè¡¨æ“ä½œ">å¤šè¡¨æ“ä½œ</h3>
<p>join</p>
<p>ä¸¤ä¸ªè¡¨:</p>
<ol>
<li>emp</li>
<li>dept</li>
</ol>
<pre><code class="language-sql">åˆ›å»ºè¡¨
CREATE TABLE dept(
deptno int,
dname string,
loc string
) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t';
åŠ è½½æ•°æ®
LOAD DATA LOCAL INPATH '/home/hadoop/data/dept.txt' OVERWRITE INTO TABLE dept;

select
e.empno,e.ename,e.sal,e.deptno,d.name
from emp e join dept d
on e.deptno=d.deptno
</code></pre>
<h4 id="å…³äº-stage-0-stage-3-stage-4">å…³äº stage-0ã€stage-3ã€stage-4</h4>
<p>ç”±äºjoinæ˜¯ä¸€ä¸ªå¤æ‚æ“ä½œï¼Œæ‰€ä»¥éœ€è¦åˆ†æ­¥éª¤è¿›è¡ŒæŸ¥è¯¢</p>
<pre><code class="language-sql">explain EXTENDED
select
e.empno,e.ename,e.sal,e.deptno,d.dname
from emp e join dept d
on e.deptno=d.deptno;
</code></pre>
<ul>
<li>stage-4 is root stage</li>
<li>stage-3 depends on stage-4</li>
<li>stage-0 depends on stage-3</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[pythonåŸºç¡€æ“ä½œ]]></title>
        <id>https://Zu3zz.github.io/post/python-basic</id>
        <link href="https://Zu3zz.github.io/post/python-basic">
        </link>
        <updated>2019-09-04T13:23:26.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  åˆ†äº«Pythonçš„ä¸€äº›éªšæ“ä½œ</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  åˆ†äº«Pythonçš„ä¸€äº›éªšæ“ä½œ</p>
<!-- more -->
<h2 id="file">file</h2>
<pre><code class="language-python">file1 = read(&quot;test.txt&quot;)
# æ‰¾åˆ°å½“å‰ä½ç½®çš„æŒ‡é’ˆ
file1.tell()
# è®©æ–‡ä»¶çš„æŒ‡ç¤ºæŒ‡é’ˆè¿›è¡Œåç§» ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨åç§»ä½ç½® ç¬¬äºŒä¸ªå‚æ•° 0ä»£è¡¨ä»æ–‡ä»¶å¼€å¤´åç§» 1ä»£è¡¨ä»å½“å‰ä½ç½®è¿›è¡Œåç§» 2ä»£è¡¨ä»æ–‡ä»¶ç»“å°¾è¿›è¡Œåç§»
file1.seek(5,0)
</code></pre>
<h2 id="errorå¤„ç†">errorå¤„ç†</h2>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[leetcode-è‚¡ç¥¨ä¹°å–é—®é¢˜(121,122,123,188,309,714)]]></title>
        <id>https://Zu3zz.github.io/post/leetcode-stock</id>
        <link href="https://Zu3zz.github.io/post/leetcode-stock">
        </link>
        <updated>2019-08-18T06:28:46.000Z</updated>
        <summary type="html"><![CDATA[<p>å¦‚ä½•ç”¨ä¸€ä¸ªåŠ¨æ€è§„åˆ’æ–¹ç¨‹è§£å†³leetcodeä¸Šæ‰€æœ‰çš„è‚¡ç¥¨ä¹°å–é—®é¢˜ï¼Œä¸”å¬æˆ‘é“æ¥</p>
]]></summary>
        <content type="html"><![CDATA[<p>å¦‚ä½•ç”¨ä¸€ä¸ªåŠ¨æ€è§„åˆ’æ–¹ç¨‹è§£å†³leetcodeä¸Šæ‰€æœ‰çš„è‚¡ç¥¨ä¹°å–é—®é¢˜ï¼Œä¸”å¬æˆ‘é“æ¥</p>
<!-- more -->
<p><strong>ç›´æ¥çœ‹é¢˜ç›®188</strong></p>
<h2 id="188-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº-iv">188. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº IV</h2>
<p>ç»™å®šä¸€ä¸ªæ•°ç»„ï¼Œå®ƒçš„ç¬¬ i ä¸ªå…ƒç´ æ˜¯ä¸€æ”¯ç»™å®šçš„è‚¡ç¥¨åœ¨ç¬¬ i å¤©çš„ä»·æ ¼ã€‚</p>
<p>è®¾è®¡ä¸€ä¸ªç®—æ³•æ¥è®¡ç®—ä½ æ‰€èƒ½è·å–çš„æœ€å¤§åˆ©æ¶¦ã€‚ä½ æœ€å¤šå¯ä»¥å®Œæˆ k ç¬”äº¤æ˜“ã€‚</p>
<p>æ³¨æ„:Â ä½ ä¸èƒ½åŒæ—¶å‚ä¸å¤šç¬”äº¤æ˜“ï¼ˆä½ å¿…é¡»åœ¨å†æ¬¡è´­ä¹°å‰å‡ºå”®æ‰ä¹‹å‰çš„è‚¡ç¥¨ï¼‰ã€‚</p>
<p>ç¤ºä¾‹Â 1:</p>
<pre><code>è¾“å…¥: [2,4,1], k = 2
è¾“å‡º: 2
è§£é‡Š: åœ¨ç¬¬ 1 å¤© (è‚¡ç¥¨ä»·æ ¼ = 2) çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 2 å¤© (è‚¡ç¥¨ä»·æ ¼ = 4) çš„æ—¶å€™å–å‡ºï¼Œè¿™ç¬”äº¤æ˜“æ‰€èƒ½è·å¾—åˆ©æ¶¦ = 4-2 = 2 ã€‚
</code></pre>
<p>ç¤ºä¾‹2ï¼š</p>
<pre><code>è¾“å…¥: [3,2,6,5,0,3], k = 2
è¾“å‡º: 7
è§£é‡Š: åœ¨ç¬¬ 2 å¤© (è‚¡ç¥¨ä»·æ ¼ = 2) çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 3 å¤© (è‚¡ç¥¨ä»·æ ¼ = 6) çš„æ—¶å€™å–å‡º, è¿™ç¬”äº¤æ˜“æ‰€èƒ½è·å¾—åˆ©æ¶¦ = 6-2 = 4 ã€‚
Â     éšåï¼Œåœ¨ç¬¬ 5 å¤© (è‚¡ç¥¨ä»·æ ¼ = 0) çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 6 å¤© (è‚¡ç¥¨ä»·æ ¼ = 3) çš„æ—¶å€™å–å‡º, è¿™ç¬”äº¤æ˜“æ‰€èƒ½è·å¾—åˆ©æ¶¦ = 3-0 = 3 ã€‚
</code></pre>
<p>å¯¹äºè¿™é“é¢˜ï¼Œæœ€éº»çƒ¦çš„æ— å¼‚äºæš´åŠ›ï¼Œå¤æ‚åº¦ä¼šå˜æˆO(2^n)ã€‚<br>
ä½¿ç”¨åŠ¨æ€è§„åˆ’(dp)ï¼Œå¯ä»¥æœ‰æ•ˆçš„è§£å†³</p>
<p>å¯¹äºä¸€ä¸ªå¸¸è§çš„dpé—®é¢˜æ¥è¯´ é€šå¸¸åˆ†ä¸¤æ­¥èµ°</p>
<ol>
<li>å®šä¹‰çŠ¶æ€æ–¹ç¨‹</li>
<li>è½¬ç§»å…¬å¼</li>
</ol>
<p>å¯¹äºè¿™é“é¢˜ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªçŠ¶æ€æ–¹ç¨‹max_profit[i]ç”¨æ¥è®°å½•åˆ°ç¬¬iå¤©çš„æœ€å¤§åˆ©æ¶¦</p>
<pre><code class="language-c++">mp[i] = mp[i-1] + -a[i](å¦‚æœä¹°å…¥) + a[i](å¦‚æœå–å‡º)
</code></pre>
<p>ä½†æ˜¯è‚¡ç¥¨çš„ä¹°å…¥éœ€è¦å½“å‰æ‰‹ä¸Šæ²¡æœ‰è‚¡ç¥¨ä¹°å…¥<br>
åŒæ · è‚¡ç¥¨çš„å–å‡ºéœ€è¦æ‰‹ä¸Šå·²ç»æŒæœ‰äº†ä¸€è‚¡çš„è‚¡ç¥¨<br>
å•çº¯çš„ä¸€ç»´æ•°ç»„æ²¡æœ‰åŠæ³•è®°å½•è¿™äº›ä¿¡æ¯ æ‰€ä»¥éœ€è¦å¢åŠ ä¸€ç»´åº¦</p>
<pre><code class="language-c++">ä½¿ç”¨mp[i][j]
j=[0,1] // 0ä¸ºå¯ä»¥ä¹° 1ä¸ºå¯ä»¥å–
</code></pre>
<p>æ­¤æ—¶çŠ¶æ€æ–¹ç¨‹å˜ä¸º</p>
<pre><code>mp[i][0] = max(mp[i-1][0] //ä¸äº¤æ˜“ ,mp[i-1][1] + a[i]// å‰ä¸€å¤©å–äº†ä¸€è‚¡)
mp[i][1] = max(mp[i-1][1] // ä¸äº¤æ˜“, mp[i-1][0] - a[i] //å‰ä¸€å¤©ä¹°äº†ä¸€è‚¡)
</code></pre>
<p>ç”±äº188é¢˜æœ‰é™åˆ¶æ¡ä»¶ï¼Œå³æœ€å¤šåªèƒ½äº¤æ˜“kæ¬¡ï¼Œè¿˜éœ€è¦è®°å½•äº¤æ˜“æ¬¡æ•°ï¼Œè¿˜éœ€è¦ä¸€ç»´æ¥è®°å½•äº¤æ˜“äº†å¤šå°‘æ¬¡<br>
æ­¤æ—¶çŠ¶æ€æ–¹ç¨‹å˜æˆäº†</p>
<pre><code>mp[i][h][k]
i è¡¨ç¤ºå¤©æ•°
j è¡¨ç¤ºæ˜¯å¦æŒæœ‰è‚¡ç¥¨
k è¡¨ç¤ºä¹‹å‰äº¤æ˜“äº†å¤šå°‘æ¬¡
</code></pre>
<p>æ­¤æ—¶åŠ¨æ€è§„åˆ’çš„è½¬ç§»æ–¹ç¨‹å˜æˆäº†å¦‚ä¸‹æ‰€ç¤º:</p>
<pre><code class="language-c++">// ä¸ºäº†æ–¹ä¾¿ç†è§£ æŠŠkæ”¾åˆ°äº†ç¬¬äºŒç»´

//å‰ä¸€å¤© è¦ä¹ˆä¸æ“ä½œ è¦ä¹ˆå–æ‰äº†ä¸€è‚¡
mp[i][k][0] = max(mp[i-1][k][0], mp[i-1][k-1][1] + a[i])

//  å‰ä¸€å¤© è¦ä¹ˆä¸æ“ä½œ è¦ä¹ˆä¹°å…¥äº†ä¸€è‚¡
mp[i][k][1] = max(mp[i-1][k][1], mp[i-1][k][0] - a[i)
</code></pre>
<p>æƒ³è¦æ±‚å‡ºæœ€å¤§çš„æ”¶ç›Š åªéœ€è¦æ‰¾åˆ°<br>
<code>mp[n-1, {0...k},0]</code>çš„æœ€å¤§å€¼å³å¯</p>
<h2 id="188ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœºiv">188.ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœºIV</h2>
<h3 id="python-solution">python solution</h3>
<pre><code class="language-python">class Solution:
    def maxProfit(self, k: int, prices: List[int]) -&gt; int:
        if not prices or not k:
            return 0
        n  = len(prices)
        # å¦‚æœkå¤§äºæ•°ç»„é•¿åº¦çš„ä¸€åŠï¼Œåˆ™å¯ä»¥ç”¨è´ªå¿ƒè§£å†³
        if k &gt; n//2:
            return self.greedy(prices)
        # åŠ¨æ€è§„åˆ’
        dp = [[[0] * 2 for _ in range(k+1)] for _ in range(n)]
        res = []
        # è®¾ç½®åˆå§‹çŠ¶æ€
        for i in range(k+1):
            dp[0][i][0], dp[0][i][1] = 0, -prices[0]
        # å¼€å§‹ä¸¤å±‚å¾ªç¯
        for i in range(1,n):
            for j in range(k+1):
                if not j:
                    dp[i][j][0] = dp[i-1][j][0]
                else:
                    dp[i][j][0] = max(dp[i-1][j][0], dp[i-1][j-1][1] + prices[i])
                dp[i][j][1] = max(dp[i-1][j][1], dp[i-1][j][0] - prices[i])
        # æ‰¾åˆ°æœ€å¤§å€¼
        for m in range(k+1):
            print(dp[n-1][m][0])
            res.append(dp[n-1][m][0])
        return max(res)
    def greedy(self, prices):
        res = 0
        for i in range(1,len(prices)):
            if prices[i] &gt; prices[i-1]:
                res += prices[i] - prices[i-1]
        return res
</code></pre>
<h2 id="309ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœºå«å†»ç»“æœŸ">309.ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœºå«å†»ç»“æœŸ</h2>
<p>å¯¹äºè¿™é“é¢˜ç›® dpçŠ¶æ€å¯ä»¥ç›¸åº”å‡å°‘ï¼Œå› ä¸ºæ²¡æœ‰æ¬¡æ•°çš„é™åˆ¶äº†ï¼Œåªéœ€è¦åšä¸€ä¸ªäºŒç»´çš„dpå°±å¯ä»¥äº† ä¸€ä¸ªç»´åº¦iæ˜¯ç”¨æ¥å­˜å‚¨å¤©æ•°ï¼Œå¦å¤–ä¸€ä¸ªç»´åº¦jç”¨æ¥å­˜å‚¨å½“å‰è‚¡ç¥¨ä¹°å–çš„çŠ¶æ€ 012åˆ†åˆ«è¡¨ç¤ºæ²¡æœ‰ä¹°å…¥ ä¹°å…¥äº† ä»¥åŠå¤„äºå†»ç»“æœŸ</p>
<h3 id="python-solution-2">python solution</h3>
<pre><code class="language-python">class Solution:
    def maxProfit(self, prices: List[int]) -&gt; int:
        if not prices:
            return 0
        n = len(prices)
        dp = [[0] * 3 for _ in range(n)]
        # 0è¡¨ç¤ºä»Šå¤©æœªæŒæœ‰ 1è¡¨ç¤ºä»Šå¤©æŒæœ‰ 2è¡¨ç¤ºä»Šå¤©å¤„äºå†»ç»“çŠ¶æ€
        dp[0][0], dp[0][1], dp[0][2] = 0,-prices[0],0
        for i in range(1,n):
            dp[i][0] = max(dp[i-1][0], dp[i-1][2])
            dp[i][1] = max(dp[i-1][1], dp[i-1][0] - prices[i])
            dp[i][2] = dp[i-1][1] + prices[i]
        return max(dp[n-1][0], dp[n-1][2])
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Leetcode-weeklyContest-150]]></title>
        <id>https://Zu3zz.github.io/post/leetcode-weeklycontest-150</id>
        <link href="https://Zu3zz.github.io/post/leetcode-weeklycontest-150">
        </link>
        <updated>2019-08-18T05:49:18.000Z</updated>
        <summary type="html"><![CDATA[<p>ç¬¬150å‘¨çš„é¢˜è§£</p>
]]></summary>
        <content type="html"><![CDATA[<p>ç¬¬150å‘¨çš„é¢˜è§£</p>
<!-- more -->
<h2 id="ç¬¬ä¸€é¢˜">ç¬¬ä¸€é¢˜</h2>
<h3 id="5048-æ‹¼å†™å•è¯">5048. æ‹¼å†™å•è¯</h3>
<p>è¦æ±‚:<br>
ç»™ä½ ä¸€ä»½ã€è¯æ±‡è¡¨ã€ï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼‰ words å’Œä¸€å¼ ã€å­—æ¯è¡¨ã€ï¼ˆå­—ç¬¦ä¸²ï¼‰ charsã€‚</p>
<p>å‡å¦‚ä½ å¯ä»¥ç”¨ chars ä¸­çš„ã€å­—æ¯ã€ï¼ˆå­—ç¬¦ï¼‰æ‹¼å†™å‡º words ä¸­çš„æŸä¸ªã€å•è¯ã€ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºä½ æŒæ¡äº†è¿™ä¸ªå•è¯ã€‚</p>
<p>æ³¨æ„ï¼šæ¯æ¬¡æ‹¼å†™æ—¶ï¼Œchars ä¸­çš„æ¯ä¸ªå­—æ¯éƒ½åªèƒ½ç”¨ä¸€æ¬¡ã€‚</p>
<p>è¿”å›è¯æ±‡è¡¨ words ä¸­ä½ æŒæ¡çš„æ‰€æœ‰å•è¯çš„ é•¿åº¦ä¹‹å’Œã€‚<br>
ç¤ºä¾‹1ï¼š</p>
<pre><code>è¾“å…¥ï¼šwords = [&quot;cat&quot;,&quot;bt&quot;,&quot;hat&quot;,&quot;tree&quot;], chars = &quot;atach&quot;
è¾“å‡ºï¼š6
è§£é‡Šï¼š 
å¯ä»¥å½¢æˆå­—ç¬¦ä¸² &quot;cat&quot; å’Œ &quot;hat&quot;ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯ 3 + 3 = 6ã€‚
</code></pre>
<p>ç¤ºä¾‹2ï¼š</p>
<pre><code>è¾“å…¥ï¼šwords = [&quot;hello&quot;,&quot;world&quot;,&quot;leetcode&quot;], chars = &quot;welldonehoneyr&quot;
è¾“å‡ºï¼š10
è§£é‡Šï¼š
å¯ä»¥å½¢æˆå­—ç¬¦ä¸² &quot;hello&quot; å’Œ &quot;world&quot;ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯ 5 + 5 = 10ã€‚
</code></pre>
<p><strong>æ€è·¯ï¼š</strong><br>
ç›´æ¥æŠŠå­—ç¬¦ä¸²é—®é¢˜è½¬åŒ–æˆä¸ºä¸€ä¸ªå¤§å°ä¸º26çš„æ•°ç»„ï¼Œå¯¹ç»™å®šçš„ã€Œå­—æ¯è¡¨ã€è¿›è¡Œéå†ï¼Œå°†æ•°ç»„çš„å¯¹åº”ä½ç½®è®°å½•ä¸‹æ¯ä¸ªå­—æ¯å‡ºç°äº†å¤šå°‘æ¬¡ï¼Œå†å¾ªç¯ä¸€éç»™å‡ºçš„ã€Œè¯æ±‡è¡¨ã€ï¼Œåªè¦è¯æ±‡è¡¨æ¯ä¸ªéƒ½æ¯”ç»™å®šçš„å­—æ¯è¡¨çš„æ•°ç»„å…ƒç´ å°ï¼Œé‚£ä¹ˆå°±è¯´æ˜å¯ä»¥è¡¨ç¤ºã€‚</p>
<p>solution in cpp:</p>
<pre><code class="language-c++">class Solution {
public:
    int countCharacters(vector&lt;string&gt;&amp; words, string chars) {
        int s[26],t[26],i,result = 0;
        memset(s,0,sizeof(s));
        for(auto c:chars)s[c-'a']++;
        for(auto d:words){
            memset(t,0,sizeof(t));
            for(auto e:d)t[e-'a']++;
            for(i=0;i&lt;26;i++) if(s[i]&lt;t[i]) break;
            if(i==26) result+=d.size();
        }
        return result;
    }
};
</code></pre>
<h2 id="ç¬¬äºŒé¢˜">ç¬¬äºŒé¢˜</h2>
<h3 id="5052æœ€å¤§å±‚å†…å…ƒç´ å’Œ">5052.æœ€å¤§å±‚å†…å…ƒç´ å’Œ</h3>
<p>ç»™ä½ ä¸€ä¸ªäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ rootã€‚è®¾æ ¹èŠ‚ç‚¹ä½äºäºŒå‰æ ‘çš„ç¬¬ 1 å±‚ï¼Œè€Œæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä½äºç¬¬ 2 å±‚ï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<p>è¯·ä½ æ‰¾å‡ºå±‚å†…å…ƒç´ ä¹‹å’Œ æœ€å¤§ çš„é‚£å‡ å±‚ï¼ˆå¯èƒ½åªæœ‰ä¸€å±‚ï¼‰çš„å±‚å·ï¼Œå¹¶è¿”å›å…¶ä¸­ æœ€å° çš„é‚£ä¸ªã€‚<br>
ç»™å®šä¸€ä¸ªäºŒå‰æ ‘ å¤§æ¦‚é•¿ä¸‹é¢è¿™æ ·<br>
å®ä¾‹ï¼š<br>
<img src="https://Zu3zz.github.io/post-images/1566107780628.jpeg" alt=""></p>
<pre><code>è¾“å…¥ï¼š[1,7,0,7,-8,null,null]
è¾“å‡ºï¼š2
è§£é‡Šï¼š
ç¬¬ 1 å±‚å„å…ƒç´ ä¹‹å’Œä¸º 1ï¼Œ
ç¬¬ 2 å±‚å„å…ƒç´ ä¹‹å’Œä¸º 7 + 0 = 7ï¼Œ
ç¬¬ 3 å±‚å„å…ƒç´ ä¹‹å’Œä¸º 7 + -8 = -1ï¼Œ
æ‰€ä»¥æˆ‘ä»¬è¿”å›ç¬¬ 2 å±‚çš„å±‚å·ï¼Œå®ƒçš„å±‚å†…å…ƒç´ ä¹‹å’Œæœ€å¤§ã€‚
</code></pre>
<p>æ€è·¯ï¼š<br>
ä½¿ç”¨ä¸€ä¸ªdictç”¨æ¥å­˜å‚¨æ¯ä¸€å±‚çš„å…ƒç´ çš„å€¼ï¼Œæ¯ä¸€å¯¹é”®å€¼å¯¹éƒ½æ˜¯å±‚æ•°å’Œç›¸å¯¹åº”çš„å€¼çš„å’Œï¼Œä½¿ç”¨dfséå†æ‰€æœ‰æ ‘çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶å°†èŠ‚ç‚¹æ‰€åœ¨çš„å±‚æ•°ä¼ è¿›å»ï¼Œä¼ è¿›å»çš„åŒæ—¶ç›´æ¥è®¿é—®å¯¹åº”çš„dictå¯¹åº”çš„å…ƒç´ ,ç›´æ¥åŠ èµ·æ¥ï¼Œæœ€åéå†ä¸€éè¾“å‡ºæœ€å¤§çš„å€¼</p>
<ul>
<li>solution in cpp:</li>
</ul>
<pre><code class="language-c++">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     TreeNode *left;
 *     TreeNode *right;
 *     TreeNode(int x) : val(x), left(NULL), right(NULL) {}
 * };
 */
class Solution {
public:
    int s[10005], n;
    void dfs(TreeNode* root, int level){
        if(!root) return;
        n = max(n,level);
        s[level]+=root-&gt;val;
        dfs(root-&gt;left,level+1);
        dfs(root-&gt;right,level+1);
    }
    int maxLevelSum(TreeNode* root) {
        memset(s,0,sizeof(s));
        n = 0;
        dfs(root,1);
        int j = 1;
        for(int i = 1;i&lt;=n;i++){
            if(s[i] &gt; s[j])
                j = i;
        }
        return j;
    }
};
</code></pre>
<ul>
<li>solution in python:</li>
</ul>
<pre><code class="language-python"># Definition for a binary tree node.
# class TreeNode:
#     def __init__(self, x):
#         self.val = x
#         self.left = None
#         self.right = None

class Solution:
    
    def maxLevelSum(self, root: TreeNode) -&gt; int:
        m,res,level = {},0,0
        def dfs(root,level):
            if root == None:
                return
            if level not in m:
                m[level] = 0
            m[level]+=root.val
            dfs(root.left,level+1)
            dfs(root.right,level+1)
        dfs(root, 1)
        min_ = -sys.maxsize
        for key in m.keys():
            if m[key] &gt; min_:
                min_, res = m[key], key
        return res
</code></pre>
<h2 id="ç¬¬ä¸‰é¢˜">ç¬¬ä¸‰é¢˜</h2>
<h3 id="5053åœ°å›¾åˆ†æ">5053.åœ°å›¾åˆ†æ</h3>
<p>ä½ ç°åœ¨æ‰‹é‡Œæœ‰ä¸€ä»½å¤§å°ä¸º N x N çš„ã€åœ°å›¾ã€ï¼ˆç½‘æ ¼ï¼‰ gridï¼Œä¸Šé¢çš„æ¯ä¸ªã€åŒºåŸŸã€ï¼ˆå•å…ƒæ ¼ï¼‰éƒ½ç”¨ 0 å’Œ 1 æ ‡è®°å¥½äº†ã€‚å…¶ä¸­ 0 ä»£è¡¨æµ·æ´‹ï¼Œ1 ä»£è¡¨é™†åœ°ï¼Œä½ çŸ¥é“è·ç¦»é™†åœ°åŒºåŸŸæœ€è¿œçš„æµ·æ´‹åŒºåŸŸæ˜¯æ˜¯å“ªä¸€ä¸ªå—ï¼Ÿè¯·è¿”å›è¯¥æµ·æ´‹åŒºåŸŸåˆ°ç¦»å®ƒæœ€è¿‘çš„é™†åœ°åŒºåŸŸçš„è·ç¦»ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œè¯´çš„è·ç¦»æ˜¯ã€æ›¼å“ˆé¡¿è·ç¦»ã€ï¼ˆ Manhattan Distanceï¼‰ï¼š(x0, y0) å’Œ (x1, y1) è¿™ä¸¤ä¸ªåŒºåŸŸä¹‹é—´çš„è·ç¦»æ˜¯ |x0 - x1| + |y0 - y1| ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬çš„åœ°å›¾ä¸Šåªæœ‰é™†åœ°æˆ–è€…æµ·æ´‹ï¼Œè¯·è¿”å› -1ã€‚</p>
<p>å®ä¾‹1ï¼š<br>
<img src="https://Zu3zz.github.io/post-images/1566108523044.jpeg" alt="å®ä¾‹"></p>
<pre><code>è¾“å…¥ï¼š[[1,0,1],[0,0,0],[1,0,1]]
è¾“å‡ºï¼š2
è§£é‡Šï¼š 
æµ·æ´‹åŒºåŸŸ (1, 1) å’Œæ‰€æœ‰é™†åœ°åŒºåŸŸä¹‹é—´çš„è·ç¦»éƒ½è¾¾åˆ°æœ€å¤§ï¼Œæœ€å¤§è·ç¦»ä¸º 2ã€‚
</code></pre>
<p>å¤ªèœäº† æ²¡åšå‡ºæ¥</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å †æ’åº(Heap Sort)]]></title>
        <id>https://Zu3zz.github.io/post/heap-sort</id>
        <link href="https://Zu3zz.github.io/post/heap-sort">
        </link>
        <updated>2019-08-17T10:17:56.000Z</updated>
        <summary type="html"><![CDATA[<p>å †æ’åºçœŸçš„æ˜¯é¢è¯•éå¸¸å®¹æ˜“è€ƒåˆ°çš„ä¸€ä¸ªé—®é¢˜äº†ï¼Œä»Šå¤©å°±æ¥èŠèŠHeap Sortã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>å †æ’åºçœŸçš„æ˜¯é¢è¯•éå¸¸å®¹æ˜“è€ƒåˆ°çš„ä¸€ä¸ªé—®é¢˜äº†ï¼Œä»Šå¤©å°±æ¥èŠèŠHeap Sortã€‚</p>
<!-- more -->
<p>å†™è¿™ç¯‡åšå®¢çš„åŸå› æ˜¯å› ä¸ºä»Šå¤©é¢è¯•è¢«é—®åˆ°äº†å¦‚ä½•ä½¿ç”¨å †æ’åºåœ¨ä¸€ä¸ªç™¾ä¸‡æ•°é‡çº§çš„æ•°ç»„ä¸­å–å‡ºå‰kå¤§çš„å…ƒç´ ï¼Œå¯èƒ½æ˜¯æœ‰ç‚¹ç´§å¼ ï¼Œæˆ‘å¤§è„‘å½“åœºçŸ­è·¯äº†ï¼Œç›´æ¥æŠŠäºŒåˆ†æœç´¢æ ‘å’Œå †æ’åºææ··äº†ï¼ŒçœŸçš„æ˜¯å¤ªä¸¢äººäº†ï¼Œæœä¸å…¶ç„¶é¢è¯•ä¹ŸæŒ‚äº†ã€‚</p>
<p>ç—›å®šæ€ç—›ï¼Œå†³å®šè‡ªå·±è®¤çœŸçš„å†å¤ä¹ å’Œå›é¡¾ä¸€ä¸‹å †æ’åºçš„æ‰€æœ‰æ“ä½œã€‚</p>
<h2 id="1åŸºæœ¬å­˜å‚¨">1.åŸºæœ¬å­˜å‚¨</h2>
<p>é¦–å…ˆä»å †è¿™ä¸ªæ•°æ®ç»“æ„è¯´èµ·ï¼Œå †å¯ä»¥åšåˆ°å…¥å †å’Œå‡ºå †éƒ½æ˜¯O(logn)çš„å¤æ‚åº¦ï¼Œå¹³å‡æ—¶é—´ä¸Šæ¯”èµ·O(1)+O(n)è¿™ç§ç»„åˆè¦å¿«å‡ºå»å¾ˆå¤šã€‚</p>
<p>é¦–å…ˆä»å †çš„åŸºæœ¬å½¢æ€è¯´èµ·ï¼Œå †æœ¬è´¨æ˜¯å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯åœ¨å­˜å‚¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹åšæ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘:å³ç´¢å¼•ä¸º0çš„ä½ç½®ä¸ºæ ¹èŠ‚ç‚¹ï¼Œç´¢å¼•ä¸º1ã€2çš„ä½ç½®ä¸ºæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªäºŒå‰å †(Binary Heap)ï¼Œå¯¹åº”çš„å°±æ˜¯ä¸€ä¸ªäºŒå‰æ ‘<br>
<img src="https://Zu3zz.github.io/post-images/1566038321792.png" alt=""><br>
å¯ä»¥çœ‹åˆ°ï¼ŒäºŒå‰å †æ»¡è¶³æ€§è´¨å¦‚ä¸‹ï¼Œæ‰€æœ‰å­èŠ‚ç‚¹å‡å°äºçˆ¶äº²èŠ‚ç‚¹ï¼Œå³<br>
<code>41&lt;62 &amp;&amp; 30&lt;62</code></p>
<p><strong>å¹¶ä¸” äºŒå‰å †æ˜¯ä¸€é¢—å®Œå…¨äºŒå‰æ ‘</strong><br>
<img src="https://Zu3zz.github.io/post-images/1566038535528.png" alt=""></p>
<p>æ‰€ä»¥ä¸Šå›¾æ‰€ç¤ºçš„å †å¯ä»¥åœ¨cppä¸­å¦‚ä¸‹æ‰€å­˜å‚¨</p>
<pre><code class="language-c++">int arr[] = {0,62,41,30,28,16,22,13,19,17,15}
</code></pre>
<p>å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œindexä¸º0çš„å…ƒç´ æ²¡æœ‰ä½¿ç”¨ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿å †æ’åºè¿›è¡Œå·¦å³èŠ‚ç‚¹çš„è®¡ç®—è§„åˆ™ã€‚<br>
æ‰€ä»¥è¿™æ ·æ‰€æœ‰çš„å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹å°±æ»¡è¶³å¦‚ä¸‹çš„å…¬å¼</p>
<pre><code class="language-c++">parent i = i /2;
left child i = 2 * i;
right child i = 2 * i +1;
</code></pre>
<p>æœ¬èŠ‚å¯¹åº”ä»£ç ï¼š<br>
<strong><a href="https://github.com/Zu3zz/Learn_some_algorithm_and_data_structure/blob/master/heap-sort/01-MaxHeap/main.cpp">äºŒå‰å †çš„å»ºç«‹ä¸åŸºæœ¬æ“ä½œ</a></strong></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä»å¤´æ¢³ç†æœåŠ¡å™¨æ¸²æŸ“åŸç†(SSR)]]></title>
        <id>https://Zu3zz.github.io/post/react-ssr</id>
        <link href="https://Zu3zz.github.io/post/react-ssr">
        </link>
        <updated>2019-08-14T14:54:33.000Z</updated>
        <summary type="html"><![CDATA[<p>è¿™ä¸€æ¬¡ï¼Œè®©æˆ‘ä»¬æ¥ä»¥Reactä¸ºä¾‹ï¼ŒæŠŠæœåŠ¡ç«¯æ¸²æŸ“(Server Side Renderï¼Œç®€ç§°â€œSSRâ€)å­¦ä¸ªæ˜æ˜ç™½ç™½ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>è¿™ä¸€æ¬¡ï¼Œè®©æˆ‘ä»¬æ¥ä»¥Reactä¸ºä¾‹ï¼ŒæŠŠæœåŠ¡ç«¯æ¸²æŸ“(Server Side Renderï¼Œç®€ç§°â€œSSRâ€)å­¦ä¸ªæ˜æ˜ç™½ç™½ã€‚</p>
<!-- more -->
<h2 id="part1å®ç°ä¸€ä¸ªåŸºç¡€çš„reactç»„ä»¶ssr">part1ï¼šå®ç°ä¸€ä¸ªåŸºç¡€çš„Reactç»„ä»¶SSR</h2>
<p>è¿™ä¸€éƒ¨åˆ†æ¥ç®€è¦å®ç°ä¸€ä¸ªReactç»„ä»¶çš„SSRã€‚</p>
<h3 id="ä¸€-ssr-vs-csr">ä¸€. SSR vs CSR</h3>
<p>ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥èµ·ä¸€ä¸ªexpressæœåŠ¡å™¨ã€‚</p>
<pre><code class="language-javascript">var express = require('express')
var app = express()

app.get('/', (req, res) =&gt; {
 res.send(
 `
   &lt;html&gt;
     &lt;head&gt;
       &lt;title&gt;hello&lt;/title&gt;
     &lt;/head&gt;
     &lt;body&gt;
       &lt;h1&gt;hello&lt;/h1&gt;
       &lt;p&gt;world&lt;/p&gt;
     &lt;/body&gt;
   &lt;/html&gt;
 `
 )
})

app.listen(3001, () =&gt; {
 console.log('listen:3001')
})
</code></pre>
<p>å¯åŠ¨ä¹‹åæ‰“å¼€localhost:3001å¯ä»¥çœ‹åˆ°é¡µé¢æ˜¾ç¤ºäº†hello worldã€‚è€Œä¸”æ‰“å¼€ç½‘é¡µæºä»£ç å¦‚ä¸‹ï¼š<br>
<img src="https://Zu3zz.github.io/post-images/1565794815666.jpg" alt=""><br>
ä¹Ÿèƒ½å¤Ÿå®Œæˆæ˜¾ç¤ºã€‚<br>
è¿™å°±æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ã€‚å…¶å®éå¸¸å¥½ç†è§£ï¼Œå°±æ˜¯æœåŠ¡å™¨è¿”å›ä¸€å †htmlå­—ç¬¦ä¸²ï¼Œç„¶åè®©æµè§ˆå™¨æ˜¾ç¤ºã€‚<br>
ä¸æœåŠ¡ç«¯æ¸²æŸ“ç›¸å¯¹çš„æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“(Client Side Render)ã€‚é‚£ä»€ä¹ˆæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ï¼Ÿ<br>
ç°åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„Reacté¡¹ç›®ï¼Œç”¨è„šæ‰‹æ¶ç”Ÿæˆé¡¹ç›®ï¼Œç„¶årunèµ·æ¥ã€‚<br>
è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°Reactè„šæ‰‹æ¶è‡ªåŠ¨ç”Ÿæˆçš„é¦–é¡µã€‚</p>
<p><img src="https://Zu3zz.github.io/post-images/1565794890546.jpg" alt=""><br>
ç„¶è€Œæ‰“å¼€ç½‘é¡µæºä»£ç ,æˆ‘ä»¬ä¼šå‘ç°ç½‘é¡µå¹¶æ²¡æœ‰ä»»ä½•DOMç»“æ„<br>
<img src="https://Zu3zz.github.io/post-images/1565794896346.jpg" alt=""><br>
bodyä¸­é™¤äº†å…¼å®¹å¤„ç†çš„noscriptæ ‡ç­¾ä¹‹å¤–ï¼Œåªæœ‰ä¸€ä¸ªidä¸ºrootçš„æ ‡ç­¾ã€‚é‚£é¦–é¡µçš„å†…å®¹æ˜¯ä»å“ªæ¥çš„å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œæ˜¯ä¸‹é¢çš„scriptä¸­æ‹‰å–çš„JSä»£ç æ§åˆ¶çš„ã€‚<br>
å› æ­¤ï¼ŒCSRå’ŒSSRæœ€å¤§çš„åŒºåˆ«åœ¨äºå‰è€…çš„é¡µé¢æ¸²æŸ“æ˜¯JSè´Ÿè´£è¿›è¡Œçš„ï¼Œè€Œåè€…æ˜¯æœåŠ¡å™¨ç«¯ç›´æ¥è¿”å›HTMLè®©æµè§ˆå™¨ç›´æ¥æ¸²æŸ“ã€‚<br>
ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“å‘¢ï¼Ÿ<br>
<img src="https://Zu3zz.github.io/post-images/1565795001030.jpeg" alt=""><br>
ä¼ ç»ŸCSRçš„å¼Šç«¯ï¼š</p>
<ol>
<li>ç”±äºé¡µé¢æ˜¾ç¤ºè¿‡ç¨‹è¦è¿›è¡ŒJSæ–‡ä»¶æ‹‰å–å’ŒReactä»£ç æ‰§è¡Œï¼Œé¦–å±åŠ è½½æ—¶é—´ä¼šæ¯”è¾ƒæ…¢ã€‚</li>
<li>å¯¹äºSEO(Search Engine Optimazition,å³æœç´¢å¼•æ“ä¼˜åŒ–)ï¼Œå®Œå…¨æ— èƒ½ä¸ºåŠ›ï¼Œå› ä¸ºæœç´¢å¼•æ“çˆ¬è™«åªè®¤è¯†htmlç»“æ„çš„å†…å®¹ï¼Œè€Œä¸èƒ½è¯†åˆ«JSä»£ç å†…å®¹ã€‚</li>
</ol>
<p>SSRçš„å‡ºç°ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›ä¼ ç»ŸCSRçš„å¼Šç«¯ã€‚</p>
<h2 id="äºŒ-å®ç°reactç»„ä»¶çš„æœåŠ¡ç«¯æ¸²æŸ“">äºŒã€å®ç°Reactç»„ä»¶çš„æœåŠ¡ç«¯æ¸²æŸ“</h2>
<p>åˆšåˆšèµ·çš„expressæœåŠ¡è¿”å›çš„åªæ˜¯ä¸€ä¸ªæ™®é€šçš„htmlå­—ç¬¦ä¸²ï¼Œä½†æˆ‘ä»¬è®¨è®ºçš„æ˜¯å¦‚ä½•è¿›è¡ŒReactçš„æœåŠ¡ç«¯æ¸²æŸ“ï¼Œé‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿ é¦–å…ˆåˆ›å»ºcontainersæ–‡ä»¶å¤¹ï¼Œæ–°å»ºä¸€ä¸ªHome.jsçš„æ–‡ä»¶ï¼Œå†™ä¸€ä¸ªç®€å•çš„Reactç»„ä»¶:</p>
<pre><code class="language-javascript">// containers/Home.js
import React from 'react';
const Home = () =&gt; {
  return (
    &lt;div&gt;
      &lt;div&gt;This is zu3zz&lt;/div&gt;
    &lt;/div&gt;
  )
}
export default Home
</code></pre>
<p>ç°åœ¨çš„ä»»åŠ¡å°±æ˜¯å°†å®ƒè½¬æ¢ä¸ºhtmlä»£ç è¿”å›ç»™æµè§ˆå™¨ã€‚<br>
æ€»æ‰€å‘¨çŸ¥ï¼ŒJSXä¸­çš„æ ‡ç­¾å…¶å®æ˜¯åŸºäºè™šæ‹ŸDOMçš„ï¼Œæœ€ç»ˆè¦é€šè¿‡ä¸€å®šçš„æ–¹æ³•å°†å…¶è½¬æ¢ä¸ºçœŸå®DOMã€‚è™šæ‹ŸDOMä¹Ÿå°±æ˜¯JSå¯¹è±¡ï¼Œå¯ä»¥çœ‹å‡ºæ•´ä¸ªæœåŠ¡ç«¯çš„æ¸²æŸ“æµç¨‹å°±æ˜¯é€šè¿‡è™šæ‹ŸDOMçš„ç¼–è¯‘æ¥å®Œæˆçš„ï¼Œå› æ­¤è™šæ‹ŸDOMå·¨å¤§çš„è¡¨è¾¾åŠ›ä¹Ÿå¯è§ä¸€æ–‘äº†ã€‚<br>
è€Œreact-domè¿™ä¸ªåº“ä¸­åˆšå¥½å®ç°äº†ç¼–è¯‘è™šæ‹ŸDOMçš„æ–¹æ³•ã€‚åšæ³•å¦‚ä¸‹:</p>
<pre><code class="language-javascript">// server/index.js
import express from 'express';
import { renderToString } from 'react-dom/server';
import Home from './containers/Home';

const app = express();
const content = renderToString(&lt;Home /&gt;);
app.get('/', function (req, res) {
   res.send(
   `
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;ssr&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id=&quot;root&quot;&gt;${content}&lt;/div&gt;
      &lt;/body&gt;
    &lt;/html&gt;
   `
   );
})
app.listen(3001, () =&gt; {
  console.log('listen:3001')
})
</code></pre>
<p>å¯åŠ¨expressæœåŠ¡ï¼Œå†æµè§ˆå™¨ä¸Šæ‰“å¼€å¯¹åº”ç«¯å£ï¼Œé¡µé¢æ˜¾ç¤ºå‡º&quot;this is sanyuan&quot;ã€‚<br>
åˆ°æ­¤ï¼Œå°±åˆæ­¥å®ç°äº†ä¸€ä¸ªReactç»„ä»¶æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ã€‚<br>
å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªéå¸¸ç®€é™‹çš„SSRï¼Œäº‹å®ä¸Šå¯¹äºå¤æ‚çš„é¡¹ç›®è€Œè¨€æ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œåœ¨ä¹‹åä¼šä¸€æ­¥æ­¥å®Œå–„ï¼Œæ‰“é€ å‡ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„Reactçš„SSRæ¡†æ¶ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç”¨ä¼˜é›…çš„ä»£ç æ­¦è£…æˆ‘ä»¬çš„koa2é¡¹ç›®]]></title>
        <id>https://Zu3zz.github.io/post/koa-tricks</id>
        <link href="https://Zu3zz.github.io/post/koa-tricks">
        </link>
        <updated>2019-08-10T08:03:41.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘ ä¼—æ‰€å‘¨çŸ¥ï¼Œkoa2æ˜¯åŸºäºnodejsçš„ä¸€æ¬¾éå¸¸è½»é‡çº§çš„æœåŠ¡ç«¯æ¡†æ¶ï¼Œå…¶ç®€å•æ˜“ä¸Šæ‰‹çš„ç‰¹æ€§æ›´æ˜¯å¤§å¤§èŠ‚çœäº†å‰ç«¯äººå‘˜å¼€å‘æœåŠ¡ç«¯apiçš„æˆæœ¬ã€‚<br>
ğŸ’» å°½ç®¡è®¸å¤šåŠŸèƒ½èƒ½å¤Ÿå®ç°ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªæœ‰ç´ å…»çš„å¼€å‘äººå‘˜ï¼Œä»£ç çš„å±‚æ¬¡æ€§ã€åæœŸå¯ç»´æŠ¤æ€§éƒ½æ˜¯éœ€è¦è€ƒè™‘å‘¨åˆ°çš„......</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘ ä¼—æ‰€å‘¨çŸ¥ï¼Œkoa2æ˜¯åŸºäºnodejsçš„ä¸€æ¬¾éå¸¸è½»é‡çº§çš„æœåŠ¡ç«¯æ¡†æ¶ï¼Œå…¶ç®€å•æ˜“ä¸Šæ‰‹çš„ç‰¹æ€§æ›´æ˜¯å¤§å¤§èŠ‚çœäº†å‰ç«¯äººå‘˜å¼€å‘æœåŠ¡ç«¯apiçš„æˆæœ¬ã€‚<br>
ğŸ’» å°½ç®¡è®¸å¤šåŠŸèƒ½èƒ½å¤Ÿå®ç°ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªæœ‰ç´ å…»çš„å¼€å‘äººå‘˜ï¼Œä»£ç çš„å±‚æ¬¡æ€§ã€åæœŸå¯ç»´æŠ¤æ€§éƒ½æ˜¯éœ€è¦è€ƒè™‘å‘¨åˆ°çš„......</p>
<!-- more -->
<p>å®è¯è¯´ï¼ŒæŒ‰ç…§koaå®˜æ–¹æ–‡æ¡£æ¥ç…§è‘«èŠ¦ç”»ç“¢ï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å†™ä¸æ¼‚äº®çš„ã€‚</p>
<p>è¿™é‡Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–ç ä¹‹å‰æœ‰ä¸€ä¸ªéå¸¸æ¸…æ™°çš„è®¤è¯†ï¼šæˆ‘ä»¬çš„ä»£ç å¦‚ä½•ç»„ç»‡ï¼Ÿå¦‚ä½•åˆ†å±‚ï¼Ÿå¦‚ä½•å¤ç”¨ï¼Ÿ</p>
<p>åœ¨ç»å†ä¸€ç³»åˆ—çš„æ€è€ƒæ–Ÿé…Œä»¥åŠä¸€äº›é¡¹ç›®çš„å®è·µä¹‹åï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›å…³äºkoaçš„å¼€å‘æŠ€å·§ï¼Œèƒ½å¤Ÿå¤§å¹…åº¦çš„æé«˜é¡¹ç›®çš„ä»£ç è´¨é‡ï¼Œå†ä¹Ÿä¸ç”¨è®©åŒä¼´ç¬‘è¯ä»£ç å†™çš„çƒ‚å•¦ï¼</p>
<h2 id="ä¸€è·¯ç”±çš„è‡ªåŠ¨åŠ è½½">ä¸€.è·¯ç”±çš„è‡ªåŠ¨åŠ è½½</h2>
<p>ä¹‹å‰æˆ‘ä»¬çš„è·¯ç”±æ€»æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ï¼Ÿå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-javascript">//app.js
const Koa = require('koa');
const app = new Koa(); 

const user = require('./app/api/user');
const store = require('./app/api/store');

app.use(user.routes());
app.use(classic.routes());
</code></pre>
<p>å¯¹äºå†™è¿‡koaé¡¹ç›®çš„äººæ¥è¯´ï¼Œè¿™æ®µä»£ç æ˜¯ä¸æ˜¯ç›¸å½“ç†Ÿæ‚‰å‘¢ï¼Ÿå…¶å®ç°åœ¨åªæœ‰ä¸¤ä¸ªè·¯ç”±æ–‡ä»¶è¿˜å¥½ï¼Œä½†å®é™…ä¸Šè¿™æ ·çš„æ–‡ä»¶æ•°é‡åºå¤§åˆ°ä¸€å®šçš„ç¨‹åº¦ï¼Œå†åƒè¿™æ ·å¼•å…¥å†useæ–¹å¼æœªå…ä¼šæ˜¾å¾—ç¹çæ‹–æ²“ã€‚é‚£æœ‰æ²¡æœ‰åŠæ³•è®©è¿™äº›æ–‡ä»¶è‡ªåŠ¨è¢«å¼•å…¥ã€è‡ªåŠ¨è¢«useå‘¢ï¼Ÿ</p>
<p>æœ‰çš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥å®‰è£…ä¸€ä¸ªéå¸¸å¥½ç”¨çš„åŒ…:<br>
<code>yarn add require-directory</code><br>
ç°åœ¨åªéœ€è¦è¿™ä¹ˆåšï¼š</p>
<pre><code class="language-javascript">//...
const Router = require('koa-router'); 
const requireDirectory = require('require-directory');
//moduleä¸ºå›ºå®šå‚æ•°ï¼Œ'./api'ä¸ºè·¯ç”±æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„(æ”¯æŒåµŒå¥—ç›®å½•ä¸‹çš„æ–‡ä»¶)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸­çš„visitä¸ºå›è°ƒå‡½æ•°
const modules = requireDirectory(module, './app/api', {
    visit: whenLoadModule
});
function whenLoadModule(obj) {
    if(obj instanceof Router) {
        app.use(obj.routes());
    }
}
</code></pre>
<p>ç”±æ­¤å¯è§ï¼Œå¥½çš„ä»£ç æ˜¯å¯ä»¥æå‡æ•ˆç‡çš„ï¼Œè¿™æ ·çš„è‡ªåŠ¨åŠ è½½è·¯ç”±çœå»äº†å¾ˆå¤šæ³¨å†Œé…ç½®çš„åŠŸå¤«ï¼Œæ˜¯ä¸æ˜¯éå¸¸é…·ç‚«ï¼Ÿ</p>
<h2 id="äºŒç”¨ç®¡ç†å™¨å°†å…¥å£æ–‡ä»¶å†…å®¹æŠ½ç¦»">äºŒ.ç”¨ç®¡ç†å™¨å°†å…¥å£æ–‡ä»¶å†…å®¹æŠ½ç¦»</h2>
<p>ç›¸ä¿¡å¾ˆå¤šäººéƒ½è¿™æ ·åšï¼šè·¯ç”±æ³¨å†Œä»£ç å†™åœ¨äº†å…¥å£æ–‡ä»¶app.jsä¸­ï¼Œä»¥åè¿›è¡Œç›¸åº”ä¸­é—´ä»¶çš„å¯¼å…¥ä¹Ÿæ˜¯å†™åœ¨è¿™ä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯å¯¹äºå…¥å£æ–‡ä»¶æ¥è¯´ï¼Œæˆ‘ä»¬æ˜¯ä¸å¸Œæœ›è®©å®ƒå˜å¾—ååˆ†è‡ƒè‚¿çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€‚å½“åœ°å°†ä¸€äº›æ“ä½œæŠ½ç¦»å‡ºæ¥ã€‚</p>
<p>åœ¨æ ¹ç›®å½•ä¸‹å»ºä¸€ä¸ªæ–‡ä»¶å¤¹coreï¼Œä»¥åä¸€äº›å…¬å…±çš„ä»£ç éƒ½å­˜æ”¾åœ¨è¿™é‡Œã€‚</p>
<pre><code class="language-javascript">//core/init.js
const requireDirectory = require('require-directory');
const Router = require('koa-router'); 

class InitManager {
    static initCore(app) {
        //æŠŠapp.jsä¸­çš„koaå®ä¾‹ä¼ è¿›æ¥
        InitManager.app = app;
        InitManager.initLoadRouters();
    }
    static initLoadRouters() {
        //æ³¨æ„è¿™é‡Œçš„è·¯å¾„æ˜¯ä¾èµ–äºå½“å‰æ–‡ä»¶æ‰€åœ¨ä½ç½®çš„
        //æœ€å¥½å†™æˆç»å¯¹è·¯å¾„
        const apiDirectory = `${process.cwd()}/app/api`
        const modules = requireDirectory(module, apiDirectory, {
            visit: whenLoadModule
        });
        function whenLoadModule(obj) {
            if(obj instanceof Router) {
                InitManager.app.use(obj.routes())
            }
        }
    }
}

module.exports = InitManager;
</code></pre>
<p>ç°åœ¨åœ¨app.jsä¸­</p>
<pre><code class="language-javascript">const Koa = require('koa');
const app = new Koa();

const InitManager = require('./core/init');
InitManager.initCore(app);
</code></pre>
<p>å¯ä»¥è¯´å·²ç»ç²¾ç®€å¾ˆå¤šäº†ï¼Œè€Œä¸”åŠŸèƒ½çš„å®ç°ç…§æ ·æ²¡æœ‰é—®é¢˜ã€‚</p>
<h2 id="ä¸‰å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åŒºåˆ†">ä¸‰.å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åŒºåˆ†</h2>
<p>æœ‰æ—¶å€™ï¼Œåœ¨ä¸¤ç§ä¸åŒçš„ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åšä¸åŒçš„å¤„ç†ï¼Œè¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬æå‰åœ¨å…¨å±€ä¸­æ³¨å…¥ç›¸åº”çš„å‚æ•°ã€‚</p>
<p>é¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­ï¼Œåˆ›å»ºconfigæ–‡ä»¶å¤¹ï¼š</p>
<pre><code class="language-javascript">//config/config.js
module.exports = {
  environment: 'dev'
}
//core/init.jsçš„initManagerç±»ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹
static loadConfig() {
    const configPath = process.cwd() + '/config/config.js';
    const config = require(configPath);
    global.config = config;
}
</code></pre>
<p>ç°åœ¨é€šè¿‡å…¨å±€çš„globalå˜é‡ä¸­å°±å¯ä»¥å–åˆ°å½“å‰çš„ç¯å¢ƒå•¦.</p>
<h2 id="å››å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶">å››.å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶</h2>
<p><strong>1.å¼‚æ­¥å¼‚å¸¸å¤„ç†çš„å‘</strong><br>
åœ¨æœåŠ¡ç«¯apiç¼–å†™çš„è¿‡ç¨‹ä¸­ï¼Œå¼‚å¸¸å¤„ç†æ˜¯éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå› ä¸ºä¸å¯èƒ½æ¯ä¸ªå‡½æ•°è¿”å›çš„ç»“æœéƒ½æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚æ— è®ºæ˜¯è¯­æ³•çš„é”™è¯¯ï¼Œè¿˜æ˜¯ä¸šåŠ¡é€»è¾‘ä¸Šçš„é”™è¯¯ï¼Œéƒ½éœ€è¦è®©å¼‚å¸¸æŠ›å‡ºï¼Œè®©é—®é¢˜ä»¥æœ€ç›´è§‚çš„æ–¹å¼æš´éœ²ï¼Œè€Œä¸æ˜¯ç›´æ¥å¿½ç•¥ã€‚å…³äºç¼–ç é£æ ¼ï¼Œã€Šä»£ç å¤§å…¨ã€‹é‡Œé¢ä¹Ÿå¼ºè°ƒè¿‡ï¼Œåœ¨ä¸€ä¸ªå‡½æ•°é‡åˆ°å¼‚å¸¸æ—¶ï¼Œæœ€å¥½çš„æ–¹å¼ä¸æ˜¯ç›´æ¥return false/nullï¼Œè€Œæ˜¯è®©å¼‚å¸¸ç›´æ¥æŠ›å‡ºã€‚</p>
<p>è€Œåœ¨JSä¸­ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½åœ¨å†™å¼‚æ­¥ä»£ç ï¼Œä¾‹å¦‚å®šæ—¶å™¨ï¼ŒPromiseç­‰ç­‰ï¼Œè¿™å°±ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç”¨try/catchçš„è¯ï¼Œè¿™æ ·çš„å¼‚æ­¥ä»£ç ä¸­çš„é”™è¯¯æˆ‘ä»¬æ˜¯æ— æ³•æ•æ‰çš„ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-javascript">function func1() {
  try {
    func2();
  } catch (error) {
    console.log('error');
  }
}

function func2() {
  setTimeout(() =&gt; {
    throw new Error('error')
  }, 1000)
}

func1();
</code></pre>
<p>æ‰§è¡Œè¿™äº›ä»£ç ï¼Œä½ ä¼šå‘ç°è¿‡äº†ä¸€ç§’åç¨‹åºç›´æ¥æŠ¥é”™ï¼Œconsole.log('error')å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯func1å¹¶æ²¡æœ‰æ•æ‰åˆ°func2çš„å¼‚å¸¸ã€‚è¿™å°±æ˜¯å¼‚æ­¥çš„é—®é¢˜æ‰€åœ¨ã€‚</p>
<p>é‚£æ€ä¹ˆè§£å†³è¿™ä¸ªå‘å‘¢ï¼Ÿ</p>
<p>æœ€ç®€ä¾¿çš„æ–¹å¼æ˜¯é‡‡å–async-awaitã€‚</p>
<pre><code class="language-javascript">async function func1() {
  try {
    await func2();
  } catch (error) {
    console.log('error');
  }
}

function func2() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      reject()
    }, 1000)
  })
}

func1();
</code></pre>
<p>åœ¨è¿™é‡Œçš„å¼‚æ­¥å‡½æ•°è¢«Promiseå°è£…ï¼Œç„¶årejectè§¦å‘func1ä¸­çš„catchï¼Œè¿™å°±æ•æ‰åˆ°äº†func2ä¸­çš„å¼‚å¸¸ã€‚åº†å¹¸çš„æ˜¯ï¼Œåƒfunc2è¿™æ ·çš„å¼‚æ­¥ä»£ç ï¼Œç°åœ¨å¸¸ç”¨çš„åº“(å¦‚axiosã€sequelize)å·²ç»ä¸ºæˆ‘ä»¬å°è£…å¥½äº†Promiseå¯¹è±¡ï¼Œä¸ç”¨æˆ‘ä»¬è‡ªå·±å»å°è£…äº†ï¼Œç›´æ¥å»é€šè¿‡async-awaitçš„æ–¹å¼å»try/catchå°±è¡Œäº†ã€‚</p>
<p>å¿ å‘Š: é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåªè¦æ˜¯å¼‚æ­¥ä»£ç ï¼Œæ‰§è¡Œä¹‹å‰å¿…é¡»è¦åŠ awaitï¼Œä¸åŠ ä¼šæŠ¥Unhandled promise rejectionçš„é”™è¯¯ã€‚è¡€çš„æ•™è®­!</p>
<p><strong>2.è®¾è®¡å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶</strong></p>
<pre><code class="language-javascript">//middlewares/exception.js
//è¿™é‡Œçš„å·¥ä½œæ˜¯æ•è·å¼‚å¸¸ç”Ÿæˆè¿”å›çš„æ¥å£
const catchError = async (ctx, next) =&gt; {
  try {
    await next();
  } catch (error) {
    if(error.errorCode) {
      ctx.body = {
        msg: error.msg,
        error_code: error.errorCode,
        request: `${ctx.method} ${ctx.path}`
      };
    } else {
      //å¯¹äºæœªçŸ¥çš„å¼‚å¸¸ï¼Œé‡‡ç”¨ç‰¹åˆ«å¤„ç†
      ctx.body = {
        msg: 'we made a mistake',
      };
    }
  }
}
module.exports = catchError;
</code></pre>
<p>åˆ°å…¥å£æ–‡ä»¶ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶ã€‚</p>
<pre><code class="language-javascript">//app.js
const catchError = require('./middlewares/exception');
app.use(catchError)
</code></pre>
<p>æ¥ç€æˆ‘ä»¬æ¥ä»¥HttpExceptionä¸ºä¾‹ç”Ÿæˆç‰¹å®šç±»å‹çš„å¼‚å¸¸ã€‚</p>
<pre><code class="language-javascript">//core/http-exception.js
class HttpException extends Error {
  //msgä¸ºå¼‚å¸¸ä¿¡æ¯ï¼ŒerrorCodeä¸ºé”™è¯¯ç (å¼€å‘äººå‘˜å†…éƒ¨çº¦å®š),codeä¸ºHTTPçŠ¶æ€ç 
  constructor(msg='æœåŠ¡å™¨å¼‚å¸¸', errorCode=10000, code=400) {
    super()
    this.errorCode = errorCode
    this.code = code
    this.msg = msg
  }
}

module.exports = {
  HttpException
}
//app/api/user.js
const Router = require('koa-router')
const router = new Router()
const { HttpException } = require('../../core/http-exception')

router.post('/user', (ctx, next) =&gt; {
    if(true){
        const error = new HttpException('ç½‘ç»œè¯·æ±‚é”™è¯¯', 10001, 400)
        throw error
  }
})
</code></pre>
<p>è¿”å›çš„æ¥å£è¿™æ ·:</p>
<pre><code class="language-json">{
	&quot;msg&quot;: &quot;ç½‘ç»œè¯·æ±‚é”™è¯¯&quot;,
	&quot;error_code&quot;:10001,
	&quot;request&quot;: &quot;POST /user&quot;
}
</code></pre>
<p>è¿™æ ·å°±æŠ›å‡ºäº†ä¸€ä¸ªç‰¹å®šç±»å‹çš„é”™è¯¯ã€‚ä½†æ˜¯åœ¨ä¸šåŠ¡ä¸­é”™è¯¯çš„ç±»å‹æ˜¯éå¸¸å¤æ‚çš„ï¼Œç°åœ¨æˆ‘å°±æŠŠæˆ‘ç¼–å†™çš„ä¸€äº›Exceptionç±»åˆ†äº«ä¸€ä¸‹ï¼Œä¾›å¤§å®¶æ¥å‚è€ƒ:</p>
<pre><code class="language-javascript">// http-exception.js
class HttpException extends Error {
  constructor(msg = 'æœåŠ¡å™¨å¼‚å¸¸', errorCode=10000, code=400) {
    super()
    this.error_code = errorCode
    this.code = code
    this.msg = msg
  }
}

class ParameterException extends HttpException{
  constructor(msg, errorCode){
    super()
    this.code = 400
    this.msg = msg || 'å‚æ•°é”™è¯¯'
    this.errorCode = errorCode || 10000
  }
}

class NotFound extends HttpException{
  constructor(msg, errorCode) {
    super();
    this.msg = msg || 'èµ„æºæœªæ‰¾åˆ°';
    this.errorCode = errorCode || 10001;
    this.code = 404;
  }
}

class AuthFailed extends HttpException{
  constructor(msg, errorCode) {
    super();
    this.msg = msg || 'æˆæƒå¤±è´¥';
    this.errorCode = errorCode || 10002;
    this.code = 404;
  }
}

class Forbidden extends HttpException{
  constructor(msg, errorCode) {
    super();
    this.msg = msg || 'ç¦æ­¢è®¿é—®';
    this.errorCode = errorCode || 10003;
    this.code = 404;
  }
}

module.exports = {
  HttpException,
  ParameterException,
  Success,
  NotFound,
  AuthFailed,
  Forbidden
}
</code></pre>
<p>å¯¹äºè¿™ç§ç»å¸¸éœ€è¦è°ƒç”¨çš„é”™è¯¯å¤„ç†çš„ä»£ç ï¼Œæœ‰å¿…è¦å°†å®ƒæ”¾åˆ°å…¨å±€ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¯¼å…¥ã€‚</p>
<p>ç°åœ¨çš„init.jsä¸­æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-javascript">// init.js
const requireDirectory = require('require-directory');
const Router = require('koa-router');

class InitManager {
  static initCore(app) {
    //å…¥å£æ–¹æ³•
    InitManager.app = app;
    InitManager.initLoadRouters();
    InitManager.loadConfig();
    InitManager.loadHttpException();//åŠ å…¥å…¨å±€çš„Exception
  }
  static initLoadRouters() {
    // path config
    const apiDirectory = `${process.cwd()}/app/api/v1`;
    requireDirectory(module, apiDirectory, {
      visit: whenLoadModule
    });

    function whenLoadModule(obj) {
      if (obj instanceof Router) {
        InitManager.app.use(obj.routes());
      }
    }
  }
  static loadConfig(path = '') {
    const configPath = path || process.cwd() + '/config/config.js';
    const config = require(configPath);
    global.config = config;
  }
  static loadHttpException() {
    const errors = require('./http-exception');
    global.errs = errors;
  }
}

module.exports = InitManager;
</code></pre>
<h2 id="äº”ä½¿ç”¨jwtå®Œæˆè®¤è¯æˆæƒ">äº”.ä½¿ç”¨JWTå®Œæˆè®¤è¯æˆæƒ</h2>
<p>JWT(å³Json Web Token)ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸèº«ä»½éªŒè¯è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚å®ƒçš„å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<p>1.å‰ç«¯å‘åç«¯ä¼ é€’ç”¨æˆ·åå’Œå¯†ç </p>
<p>2.ç”¨æˆ·åå’Œå¯†ç åœ¨åç«¯æ ¸å®æˆåŠŸåï¼Œè¿”å›å‰ç«¯ä¸€ä¸ªtoken(æˆ–å­˜åœ¨cookieä¸­)</p>
<p>3.å‰ç«¯æ‹¿åˆ°tokenå¹¶è¿›è¡Œä¿å­˜</p>
<p>4.å‰ç«¯è®¿é—®åç«¯æ¥å£æ—¶å…ˆè¿›è¡Œtokenè®¤è¯ï¼Œè®¤è¯é€šè¿‡æ‰èƒ½è®¿é—®æ¥å£ã€‚</p>
<p>é‚£ä¹ˆåœ¨koaä¸­æˆ‘ä»¬éœ€è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ</p>
<p>åœ¨ç”Ÿæˆtokené˜¶æ®µï¼šé¦–å…ˆæ˜¯éªŒè¯è´¦æˆ·ï¼Œç„¶åç”Ÿæˆtokenä»¤ç‰Œï¼Œä¼ ç»™å‰ç«¯ã€‚</p>
<p>åœ¨è®¤è¯tokené˜¶æ®µ: å®Œæˆè®¤è¯ä¸­é—´ä»¶çš„ç¼–å†™ï¼Œå¯¹å‰ç«¯çš„è®¿é—®åšä¸€å±‚æ‹¦æˆªï¼Œtokenè®¤è¯è¿‡åæ‰èƒ½è®¿é—®åé¢çš„æ¥å£ã€‚</p>
<p><strong>1.ç”Ÿæˆtoken</strong><br>
å…ˆå®‰è£…ä¸¤ä¸ªåŒ…:</p>
<pre><code class="language-javascript">yarn add jsonwebtoken basic-auth
//config.js
module.exports = {
  environment: 'dev',
  database: {
    dbName: 'island',
    host: 'localhost',
    port: 3306,
    user: 'root',
    password: 'fjfj'
  },
  security: {
    secretKey: 'lajsdflsdjfljsdljfls',//ç”¨æ¥ç”Ÿæˆtokençš„keyå€¼
    expiresIn: 60 * 60//è¿‡æœŸæ—¶é—´
  }
}

//utils.js 
//ç”Ÿæˆtokenä»¤ç‰Œå‡½æ•°ï¼Œuidä¸ºç”¨æˆ·idï¼Œscopeä¸ºæƒé™ç­‰çº§(ç±»å‹ä¸ºæ•°å­—ï¼Œå†…éƒ¨çº¦å®š)
const generateToken = function(uid, scope){
    const { secretKey, expiresIn } = global.config.security
    //ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç”¨æˆ·ä¿¡æ¯çš„jså¯¹è±¡ï¼Œç¬¬äºŒä¸ªä¸ºç”¨æ¥ç”Ÿæˆtokençš„keyå€¼ï¼Œç¬¬ä¸‰ä¸ªä¸ºé…ç½®é¡¹
    const token = jwt.sign({
        uid,
        scope
    },secretKey,{
        expiresIn
    })
    return token
}
</code></pre>
<p><strong>2.Authä¸­é—´ä»¶å®ç°æ‹¦æˆª</strong></p>
<pre><code class="language-javascript">//å‰ç«¯ä¼ tokenæ–¹å¼
//åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸ŠAuthorization:`Basic ${base64(token+&quot;:&quot;)}`å³å¯
//å…¶ä¸­base64ä¸ºç¬¬ä¸‰æ–¹åº“js-base64å¯¼å‡ºçš„ä¸€ä¸ªæ–¹æ³•

//middlewares/auth.js
const basicAuth = require('basic-auth');
const jwt = require('jsonwebtoken');

class Auth {
  constructor(level) {
    Auth.USER = 8;
    Auth.ADMIN = 16;
    this.level = level || 1;
  }
  //æ³¨æ„è¿™é‡Œçš„mæ˜¯ä¸€ä¸ªå±æ€§
  get m() {
    return async (ctx, next) =&gt; {
      const userToken = basicAuth(ctx.req);
      let errMsg = 'tokenä¸åˆæ³•';

      if(!userToken || !userToken.name) {
        throw new global.errs.Forbidden();
      }
      try {
        //å°†å‰ç«¯ä¼ è¿‡æ¥çš„tokenå€¼è¿›è¡Œè®¤è¯ï¼Œå¦‚æœæˆåŠŸä¼šè¿”å›ä¸€ä¸ªdecodeå¯¹è±¡ï¼ŒåŒ…å«uidå’Œscope
        var decode = jwt.verify(userToken.name, global.config.security.secretKey);
      } catch (error) {
        // tokenä¸åˆæ³•
        // æˆ–tokenè¿‡æœŸ
        // æŠ›å¼‚å¸¸
        errMsg = '//æ ¹æ®æƒ…å†µå®šä¹‰'
        throw new global.errs.Forbidden(errMsg);
      }
      //å°†uidå’ŒscopeæŒ‚è½½ctxä¸­
      ctx.auth = {
        uid: decode.uid,
        scope: decode.scope
      };
      //ç°åœ¨èµ°åˆ°è¿™é‡Œtokenè®¤è¯é€šè¿‡
      await next();
    }
  }
}
module.exports = Auth;
</code></pre>
<p>åœ¨è·¯ç”±ç›¸åº”æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹:</p>
<pre><code class="language-javascript">//ä¸­é—´ä»¶å…ˆè¡Œï¼Œå¦‚æœä¸­é—´ä»¶ä¸­è®¤è¯æœªé€šè¿‡ï¼Œåˆ™ä¸ä¼šèµ°åˆ°è·¯ç”±å¤„ç†é€»è¾‘è¿™é‡Œæ¥
router.post('/xxx', new Auth().m , async (ctx, next) =&gt; {
    //......
})
</code></pre>
<h2 id="å…­requireè·¯å¾„åˆ«å">å…­.requireè·¯å¾„åˆ«å</h2>
<p>åœ¨å¼€å‘çš„è¿‡ç¨‹ï¼Œå½“é¡¹ç›®çš„ç›®å½•è¶Šæ¥è¶Šå¤æ‚çš„æ—¶å€™ï¼ŒåŒ…çš„å¼•ç”¨è·¯å¾„ä¹Ÿå˜å¾—è¶Šæ¥è¶Šéº»çƒ¦ã€‚æ›¾ç»å°±å‡ºç°è¿‡è¿™æ ·çš„å¯¼å…¥è·¯å¾„:</p>
<pre><code class="language-javascript">const Favor = require('../../../models/favor');
</code></pre>
<p>ç”šè‡³è¿˜æœ‰æ¯”è¿™ä¸ªæ›´åŠ å†—é•¿çš„å¯¼å…¥æ–¹å¼ï¼Œä½œä¸ºä¸€ä¸ªæœ‰ä»£ç æ´ç™–çš„ç¨‹åºå‘˜ï¼Œå®åœ¨è®©äººçœ‹çš„éå¸¸ä¸çˆ½ã€‚å…¶å®é€šè¿‡ç»å¯¹è·¯å¾„process.cwd()çš„æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥è§£å†³è¿™æ ·ä¸€ä¸ªé—®é¢˜çš„ï¼Œä½†æ˜¯å½“ç›®å½•æ·±åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™ï¼Œå¯¼å…¥çš„ä»£ç ä¹Ÿéå¸¸ç¹å†—ã€‚é‚£æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹å¼å‘¢ï¼Ÿ</p>
<p>ä½¿ç”¨module-aliaså°†è·¯å¾„åˆ«åå°±å¯ä»¥ã€‚</p>
<pre><code class="language-javascript">yarn add module-alias
//package.jsonæ·»åŠ å¦‚ä¸‹å†…å®¹
  &quot;_moduleAliases&quot;: {
    &quot;@models&quot;: &quot;app/models&quot;
  },
</code></pre>
<p>ç„¶ååœ¨app.jså¼•å…¥è¿™ä¸ªåº“ï¼š</p>
<pre><code class="language-javascript">//å¼•å…¥å³å¯
require('module-alias/register');
</code></pre>
<p>ç°åœ¨å¼•å…¥ä»£ç å°±å˜æˆè¿™æ ·äº†:</p>
<pre><code class="language-javascript">const Favor = require('@models/favor');
</code></pre>
<p>ç®€æ´æ¸…æ™°äº†è®¸å¤šï¼Œä¹Ÿæ›´å®¹æ˜“è®©äººç»´æŠ¤ã€‚</p>
<h2 id="ä¸ƒåˆ©ç”¨sequelizeçš„äº‹åŠ¡è§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜">ä¸ƒ.åˆ©ç”¨sequelizeçš„äº‹åŠ¡è§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜</h2>
<p>å½“ä¸€ä¸ªä¸šåŠ¡è¦è¿›è¡Œå¤šé¡¹æ•°æ®åº“çš„æ“ä½œæ—¶ï¼Œæ‹¿ç‚¹èµåŠŸèƒ½ä¸ºä¾‹ï¼Œé¦–å…ˆä½ å¾—åœ¨ç‚¹èµè®°å½•çš„è¡¨ä¸­å¢åŠ è®°å½•ï¼Œç„¶åä½ è¦å°†å¯¹åº”å¯¹è±¡çš„ç‚¹èµæ•°åŠ 1ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¿…é¡»è¦ä¸€èµ·å®Œæˆçš„ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ“ä½œæˆåŠŸï¼Œå¦ä¸€ä¸ªæ“ä½œå‡ºç°äº†é—®é¢˜ï¼Œé‚£å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ›å¦‚æœå‡ºç°äº†ä»»ä½•é—®é¢˜ï¼Œç›´æ¥å›æ»šåˆ°æœªæ“ä½œä¹‹å‰çš„çŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™å»ºè®®ç”¨æ•°æ®åº“äº‹åŠ¡çš„æ“ä½œã€‚åˆ©ç”¨sequelizeçš„transactionæ˜¯å¯ä»¥å®Œæˆçš„ï¼ŒæŠŠä¸šåŠ¡éƒ¨åˆ†çš„ä»£ç è´´ä¸€ä¸‹:</p>
<pre><code class="language-javascript">async like(art_id, uid) {
    //æŸ¥æ‰¾æ˜¯å¦æœ‰é‡å¤çš„
    const favor = await Favor.findOne({
      where: { art_id, uid }
      }
    );
    //æœ‰é‡å¤åˆ™æŠ›å¼‚å¸¸
    if (favor) {
      throw new global.errs.LikeError('ä½ å·²ç»ç‚¹è¿‡èµäº†');
    }
    //dbä¸ºsequelizeçš„å®ä¾‹
    //ä¸‹é¢æ˜¯äº‹åŠ¡çš„æ“ä½œ
    return db.transaction(async t =&gt; {
      //1.åˆ›å»ºç‚¹èµè®°å½•
      await Favor.create({ art_id, uid }, { transaction: t });
      //2.å¢åŠ ç‚¹èµæ•°
      const art = await Art.getData(art_id, type);//æ‹¿åˆ°è¢«ç‚¹èµçš„å¯¹è±¡
      await art.increment('fav_nums', { by: 1, transaction: t });//åŠ 1æ“ä½œ
    });
  }
</code></pre>
<p>sequelizeä¸­çš„transactionå¤§æ¦‚å°±æ˜¯è¿™æ ·åšçš„ï¼Œå®˜æ–¹æ–‡æ¡£æ˜¯promiseçš„æ–¹å¼ï¼Œçœ‹èµ·æ¥å®åœ¨å¤ªä¸ç¾è§‚ï¼Œæ”¹æˆasync/awaitæ–¹å¼ä¼šå¥½å¾ˆå¤šï¼Œä½†æ˜¯åƒä¸‡ä¸è¦å¿˜äº†å†™awaitã€‚</p>
<p>å…³äºkoa2çš„ä»£ç ä¼˜åŒ–ï¼Œå°±å…ˆåˆ†äº«åˆ°è¿™é‡Œï¼Œæœªå®Œå¾…ç»­ï¼Œåç»­ä¼šä¸æ–­è¡¥å……ã€‚æ¬¢è¿ç‚¹èµã€ç•™è¨€!</p>
]]></content>
    </entry>
</feed>