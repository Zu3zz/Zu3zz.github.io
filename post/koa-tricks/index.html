<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é£è¢–</title>
<meta name="description" content="çƒŸè›¾æ•›ç•¥ä¸èƒœæ€ï¼Œé£è¢–ä½æ˜‚å¦‚æœ‰æƒ…" />
<link rel="shortcut icon" href="https://zu3zz.coding.me/favicon.ico?v=1588818080803">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link href="https://cdn.remixicon.com/releases/v1.3.1/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">

<link rel="stylesheet" href="https://zu3zz.coding.me/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="é£è¢– - Atom Feed" href="https://zu3zz.coding.me/atom.xml">



  </head>
  <body>
    <div id="app" class="main px-4 flex flex-col lg:flex-row">
      <div id="sidebar" class="sidebar-wrapper lg:static lg:w-1/4">
  <div class="lg:sticky top-0">
    <div class="sidebar-content">
      <div class="flex lg:block p-4 lg:px-0 items-center fixed lg:static lg:block top-0 right-0 left-0 bg-white z-50">
        <i class="remixicon-menu-2-line lg:mt-4 text-2xl cursor-pointer animated fadeIn" onclick="openMenu()"></i>
        <a href="https://zu3zz.coding.me">
          <img class="animated fadeInLeft avatar rounded-lg mx-4 lg:mt-32 lg:mx-0 mt-0 lg:w-24 lg:h-24 w-12 w-12" src="https://zu3zz.coding.me/images/avatar.png?v=1588818080803" alt="">
        </a>
        <h1 class="animated fadeInLeft lg:text-4xl font-extrabold lg:mt-8 mt-0 text-xl" style="animation-delay: 0.2s">é£è¢–</h1>
      </div>
      
        <div class="animated fadeInLeft" style="animation-delay: 0.4s">
          <p class="my-4 text-gray-600 font-light hidden lg:block">
            æ–‡ç« ç›®å½•
          </p>
          <div class="toc-container hidden lg:block">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%B8%80%E8%B7%AF%E7%94%B1%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD">ä¸€.è·¯ç”±çš„è‡ªåŠ¨åŠ è½½</a></li>
<li><a href="#%E4%BA%8C%E7%94%A8%E7%AE%A1%E7%90%86%E5%99%A8%E5%B0%86%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%8A%BD%E7%A6%BB">äºŒ.ç”¨ç®¡ç†å™¨å°†å…¥å£æ–‡ä»¶å†…å®¹æŠ½ç¦»</a></li>
<li><a href="#%E4%B8%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%92%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E5%8C%BA%E5%88%86">ä¸‰.å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åŒºåˆ†</a></li>
<li><a href="#%E5%9B%9B%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%AD%E9%97%B4%E4%BB%B6">å››.å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶</a></li>
<li><a href="#%E4%BA%94%E4%BD%BF%E7%94%A8jwt%E5%AE%8C%E6%88%90%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83">äº”.ä½¿ç”¨JWTå®Œæˆè®¤è¯æˆæƒ</a></li>
<li><a href="#%E5%85%ADrequire%E8%B7%AF%E5%BE%84%E5%88%AB%E5%90%8D">å…­.requireè·¯å¾„åˆ«å</a></li>
<li><a href="#%E4%B8%83%E5%88%A9%E7%94%A8sequelize%E7%9A%84%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98">ä¸ƒ.åˆ©ç”¨sequelizeçš„äº‹åŠ¡è§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      
    </div>
  </div>
</div>

<div class="menu-container">
  <i class="remixicon-arrow-left-line text-2xl cursor-pointer animated fadeIn close-menu-btn" onclick="closeMenu()"></i>
  <div>
    
      
        <a href="/" class="menu" style="animation-delay: 0s">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu" style="animation-delay: 0.2s">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu" style="animation-delay: 0.4s">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu" style="animation-delay: 0.6000000000000001s">
          å…³äº
        </a>
      
    
      
        <a href="/projects" class="menu" style="animation-delay: 0.8s">
          é¡¹ç›®
        </a>
      
    
  </div>
  <div class="site-footer">
    <div class="py-4 text-gray-700">By 3zz.</div>
    <a class="rss" href="https://zu3zz.coding.me/atom.xml" target="_blank">RSS</a>
  </div>
</div>
<div class="mask" onclick="closeMenu()">
</div>
      <div class="content-wrapper py-32 lg:p-8 lg:w-3/4 post-detail animated fadeIn">
        <h1 class="text-3xl font-bold lg:mt-16">ç”¨ä¼˜é›…çš„ä»£ç æ­¦è£…æˆ‘ä»¬çš„koa2é¡¹ç›®</h1>
        <div class="text-sm text-gray-700 lg:my-8">
          2019-08-10 / 14 min read
        </div>
        
        <div class="post-content yue">
          <p>ğŸ‘ ä¼—æ‰€å‘¨çŸ¥ï¼Œkoa2æ˜¯åŸºäºnodejsçš„ä¸€æ¬¾éå¸¸è½»é‡çº§çš„æœåŠ¡ç«¯æ¡†æ¶ï¼Œå…¶ç®€å•æ˜“ä¸Šæ‰‹çš„ç‰¹æ€§æ›´æ˜¯å¤§å¤§èŠ‚çœäº†å‰ç«¯äººå‘˜å¼€å‘æœåŠ¡ç«¯apiçš„æˆæœ¬ã€‚<br>
ğŸ’» å°½ç®¡è®¸å¤šåŠŸèƒ½èƒ½å¤Ÿå®ç°ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªæœ‰ç´ å…»çš„å¼€å‘äººå‘˜ï¼Œä»£ç çš„å±‚æ¬¡æ€§ã€åæœŸå¯ç»´æŠ¤æ€§éƒ½æ˜¯éœ€è¦è€ƒè™‘å‘¨åˆ°çš„......</p>
<!-- more -->
<p>å®è¯è¯´ï¼ŒæŒ‰ç…§koaå®˜æ–¹æ–‡æ¡£æ¥ç…§è‘«èŠ¦ç”»ç“¢ï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å†™ä¸æ¼‚äº®çš„ã€‚</p>
<p>è¿™é‡Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–ç ä¹‹å‰æœ‰ä¸€ä¸ªéå¸¸æ¸…æ™°çš„è®¤è¯†ï¼šæˆ‘ä»¬çš„ä»£ç å¦‚ä½•ç»„ç»‡ï¼Ÿå¦‚ä½•åˆ†å±‚ï¼Ÿå¦‚ä½•å¤ç”¨ï¼Ÿ</p>
<p>åœ¨ç»å†ä¸€ç³»åˆ—çš„æ€è€ƒæ–Ÿé…Œä»¥åŠä¸€äº›é¡¹ç›®çš„å®è·µä¹‹åï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›å…³äºkoaçš„å¼€å‘æŠ€å·§ï¼Œèƒ½å¤Ÿå¤§å¹…åº¦çš„æé«˜é¡¹ç›®çš„ä»£ç è´¨é‡ï¼Œå†ä¹Ÿä¸ç”¨è®©åŒä¼´ç¬‘è¯ä»£ç å†™çš„çƒ‚å•¦ï¼</p>
<h2 id="ä¸€è·¯ç”±çš„è‡ªåŠ¨åŠ è½½">ä¸€.è·¯ç”±çš„è‡ªåŠ¨åŠ è½½</h2>
<p>ä¹‹å‰æˆ‘ä»¬çš„è·¯ç”±æ€»æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ï¼Ÿå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-javascript">//app.js
const Koa = require('koa');
const app = new Koa(); 

const user = require('./app/api/user');
const store = require('./app/api/store');

app.use(user.routes());
app.use(classic.routes());
</code></pre>
<p>å¯¹äºå†™è¿‡koaé¡¹ç›®çš„äººæ¥è¯´ï¼Œè¿™æ®µä»£ç æ˜¯ä¸æ˜¯ç›¸å½“ç†Ÿæ‚‰å‘¢ï¼Ÿå…¶å®ç°åœ¨åªæœ‰ä¸¤ä¸ªè·¯ç”±æ–‡ä»¶è¿˜å¥½ï¼Œä½†å®é™…ä¸Šè¿™æ ·çš„æ–‡ä»¶æ•°é‡åºå¤§åˆ°ä¸€å®šçš„ç¨‹åº¦ï¼Œå†åƒè¿™æ ·å¼•å…¥å†useæ–¹å¼æœªå…ä¼šæ˜¾å¾—ç¹çæ‹–æ²“ã€‚é‚£æœ‰æ²¡æœ‰åŠæ³•è®©è¿™äº›æ–‡ä»¶è‡ªåŠ¨è¢«å¼•å…¥ã€è‡ªåŠ¨è¢«useå‘¢ï¼Ÿ</p>
<p>æœ‰çš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥å®‰è£…ä¸€ä¸ªéå¸¸å¥½ç”¨çš„åŒ…:<br>
<code>yarn add require-directory</code><br>
ç°åœ¨åªéœ€è¦è¿™ä¹ˆåšï¼š</p>
<pre><code class="language-javascript">//...
const Router = require('koa-router'); 
const requireDirectory = require('require-directory');
//moduleä¸ºå›ºå®šå‚æ•°ï¼Œ'./api'ä¸ºè·¯ç”±æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„(æ”¯æŒåµŒå¥—ç›®å½•ä¸‹çš„æ–‡ä»¶)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸­çš„visitä¸ºå›è°ƒå‡½æ•°
const modules = requireDirectory(module, './app/api', {
    visit: whenLoadModule
});
function whenLoadModule(obj) {
    if(obj instanceof Router) {
        app.use(obj.routes());
    }
}
</code></pre>
<p>ç”±æ­¤å¯è§ï¼Œå¥½çš„ä»£ç æ˜¯å¯ä»¥æå‡æ•ˆç‡çš„ï¼Œè¿™æ ·çš„è‡ªåŠ¨åŠ è½½è·¯ç”±çœå»äº†å¾ˆå¤šæ³¨å†Œé…ç½®çš„åŠŸå¤«ï¼Œæ˜¯ä¸æ˜¯éå¸¸é…·ç‚«ï¼Ÿ</p>
<h2 id="äºŒç”¨ç®¡ç†å™¨å°†å…¥å£æ–‡ä»¶å†…å®¹æŠ½ç¦»">äºŒ.ç”¨ç®¡ç†å™¨å°†å…¥å£æ–‡ä»¶å†…å®¹æŠ½ç¦»</h2>
<p>ç›¸ä¿¡å¾ˆå¤šäººéƒ½è¿™æ ·åšï¼šè·¯ç”±æ³¨å†Œä»£ç å†™åœ¨äº†å…¥å£æ–‡ä»¶app.jsä¸­ï¼Œä»¥åè¿›è¡Œç›¸åº”ä¸­é—´ä»¶çš„å¯¼å…¥ä¹Ÿæ˜¯å†™åœ¨è¿™ä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯å¯¹äºå…¥å£æ–‡ä»¶æ¥è¯´ï¼Œæˆ‘ä»¬æ˜¯ä¸å¸Œæœ›è®©å®ƒå˜å¾—ååˆ†è‡ƒè‚¿çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€‚å½“åœ°å°†ä¸€äº›æ“ä½œæŠ½ç¦»å‡ºæ¥ã€‚</p>
<p>åœ¨æ ¹ç›®å½•ä¸‹å»ºä¸€ä¸ªæ–‡ä»¶å¤¹coreï¼Œä»¥åä¸€äº›å…¬å…±çš„ä»£ç éƒ½å­˜æ”¾åœ¨è¿™é‡Œã€‚</p>
<pre><code class="language-javascript">//core/init.js
const requireDirectory = require('require-directory');
const Router = require('koa-router'); 

class InitManager {
    static initCore(app) {
        //æŠŠapp.jsä¸­çš„koaå®ä¾‹ä¼ è¿›æ¥
        InitManager.app = app;
        InitManager.initLoadRouters();
    }
    static initLoadRouters() {
        //æ³¨æ„è¿™é‡Œçš„è·¯å¾„æ˜¯ä¾èµ–äºå½“å‰æ–‡ä»¶æ‰€åœ¨ä½ç½®çš„
        //æœ€å¥½å†™æˆç»å¯¹è·¯å¾„
        const apiDirectory = `${process.cwd()}/app/api`
        const modules = requireDirectory(module, apiDirectory, {
            visit: whenLoadModule
        });
        function whenLoadModule(obj) {
            if(obj instanceof Router) {
                InitManager.app.use(obj.routes())
            }
        }
    }
}

module.exports = InitManager;
</code></pre>
<p>ç°åœ¨åœ¨app.jsä¸­</p>
<pre><code class="language-javascript">const Koa = require('koa');
const app = new Koa();

const InitManager = require('./core/init');
InitManager.initCore(app);
</code></pre>
<p>å¯ä»¥è¯´å·²ç»ç²¾ç®€å¾ˆå¤šäº†ï¼Œè€Œä¸”åŠŸèƒ½çš„å®ç°ç…§æ ·æ²¡æœ‰é—®é¢˜ã€‚</p>
<h2 id="ä¸‰å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åŒºåˆ†">ä¸‰.å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åŒºåˆ†</h2>
<p>æœ‰æ—¶å€™ï¼Œåœ¨ä¸¤ç§ä¸åŒçš„ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åšä¸åŒçš„å¤„ç†ï¼Œè¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬æå‰åœ¨å…¨å±€ä¸­æ³¨å…¥ç›¸åº”çš„å‚æ•°ã€‚</p>
<p>é¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­ï¼Œåˆ›å»ºconfigæ–‡ä»¶å¤¹ï¼š</p>
<pre><code class="language-javascript">//config/config.js
module.exports = {
  environment: 'dev'
}
//core/init.jsçš„initManagerç±»ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹
static loadConfig() {
    const configPath = process.cwd() + '/config/config.js';
    const config = require(configPath);
    global.config = config;
}
</code></pre>
<p>ç°åœ¨é€šè¿‡å…¨å±€çš„globalå˜é‡ä¸­å°±å¯ä»¥å–åˆ°å½“å‰çš„ç¯å¢ƒå•¦.</p>
<h2 id="å››å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶">å››.å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶</h2>
<p><strong>1.å¼‚æ­¥å¼‚å¸¸å¤„ç†çš„å‘</strong><br>
åœ¨æœåŠ¡ç«¯apiç¼–å†™çš„è¿‡ç¨‹ä¸­ï¼Œå¼‚å¸¸å¤„ç†æ˜¯éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå› ä¸ºä¸å¯èƒ½æ¯ä¸ªå‡½æ•°è¿”å›çš„ç»“æœéƒ½æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚æ— è®ºæ˜¯è¯­æ³•çš„é”™è¯¯ï¼Œè¿˜æ˜¯ä¸šåŠ¡é€»è¾‘ä¸Šçš„é”™è¯¯ï¼Œéƒ½éœ€è¦è®©å¼‚å¸¸æŠ›å‡ºï¼Œè®©é—®é¢˜ä»¥æœ€ç›´è§‚çš„æ–¹å¼æš´éœ²ï¼Œè€Œä¸æ˜¯ç›´æ¥å¿½ç•¥ã€‚å…³äºç¼–ç é£æ ¼ï¼Œã€Šä»£ç å¤§å…¨ã€‹é‡Œé¢ä¹Ÿå¼ºè°ƒè¿‡ï¼Œåœ¨ä¸€ä¸ªå‡½æ•°é‡åˆ°å¼‚å¸¸æ—¶ï¼Œæœ€å¥½çš„æ–¹å¼ä¸æ˜¯ç›´æ¥return false/nullï¼Œè€Œæ˜¯è®©å¼‚å¸¸ç›´æ¥æŠ›å‡ºã€‚</p>
<p>è€Œåœ¨JSä¸­ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½åœ¨å†™å¼‚æ­¥ä»£ç ï¼Œä¾‹å¦‚å®šæ—¶å™¨ï¼ŒPromiseç­‰ç­‰ï¼Œè¿™å°±ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç”¨try/catchçš„è¯ï¼Œè¿™æ ·çš„å¼‚æ­¥ä»£ç ä¸­çš„é”™è¯¯æˆ‘ä»¬æ˜¯æ— æ³•æ•æ‰çš„ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-javascript">function func1() {
  try {
    func2();
  } catch (error) {
    console.log('error');
  }
}

function func2() {
  setTimeout(() =&gt; {
    throw new Error('error')
  }, 1000)
}

func1();
</code></pre>
<p>æ‰§è¡Œè¿™äº›ä»£ç ï¼Œä½ ä¼šå‘ç°è¿‡äº†ä¸€ç§’åç¨‹åºç›´æ¥æŠ¥é”™ï¼Œconsole.log('error')å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯func1å¹¶æ²¡æœ‰æ•æ‰åˆ°func2çš„å¼‚å¸¸ã€‚è¿™å°±æ˜¯å¼‚æ­¥çš„é—®é¢˜æ‰€åœ¨ã€‚</p>
<p>é‚£æ€ä¹ˆè§£å†³è¿™ä¸ªå‘å‘¢ï¼Ÿ</p>
<p>æœ€ç®€ä¾¿çš„æ–¹å¼æ˜¯é‡‡å–async-awaitã€‚</p>
<pre><code class="language-javascript">async function func1() {
  try {
    await func2();
  } catch (error) {
    console.log('error');
  }
}

function func2() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      reject()
    }, 1000)
  })
}

func1();
</code></pre>
<p>åœ¨è¿™é‡Œçš„å¼‚æ­¥å‡½æ•°è¢«Promiseå°è£…ï¼Œç„¶årejectè§¦å‘func1ä¸­çš„catchï¼Œè¿™å°±æ•æ‰åˆ°äº†func2ä¸­çš„å¼‚å¸¸ã€‚åº†å¹¸çš„æ˜¯ï¼Œåƒfunc2è¿™æ ·çš„å¼‚æ­¥ä»£ç ï¼Œç°åœ¨å¸¸ç”¨çš„åº“(å¦‚axiosã€sequelize)å·²ç»ä¸ºæˆ‘ä»¬å°è£…å¥½äº†Promiseå¯¹è±¡ï¼Œä¸ç”¨æˆ‘ä»¬è‡ªå·±å»å°è£…äº†ï¼Œç›´æ¥å»é€šè¿‡async-awaitçš„æ–¹å¼å»try/catchå°±è¡Œäº†ã€‚</p>
<p>å¿ å‘Š: é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåªè¦æ˜¯å¼‚æ­¥ä»£ç ï¼Œæ‰§è¡Œä¹‹å‰å¿…é¡»è¦åŠ awaitï¼Œä¸åŠ ä¼šæŠ¥Unhandled promise rejectionçš„é”™è¯¯ã€‚è¡€çš„æ•™è®­!</p>
<p><strong>2.è®¾è®¡å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶</strong></p>
<pre><code class="language-javascript">//middlewares/exception.js
//è¿™é‡Œçš„å·¥ä½œæ˜¯æ•è·å¼‚å¸¸ç”Ÿæˆè¿”å›çš„æ¥å£
const catchError = async (ctx, next) =&gt; {
  try {
    await next();
  } catch (error) {
    if(error.errorCode) {
      ctx.body = {
        msg: error.msg,
        error_code: error.errorCode,
        request: `${ctx.method} ${ctx.path}`
      };
    } else {
      //å¯¹äºæœªçŸ¥çš„å¼‚å¸¸ï¼Œé‡‡ç”¨ç‰¹åˆ«å¤„ç†
      ctx.body = {
        msg: 'we made a mistake',
      };
    }
  }
}
module.exports = catchError;
</code></pre>
<p>åˆ°å…¥å£æ–‡ä»¶ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶ã€‚</p>
<pre><code class="language-javascript">//app.js
const catchError = require('./middlewares/exception');
app.use(catchError)
</code></pre>
<p>æ¥ç€æˆ‘ä»¬æ¥ä»¥HttpExceptionä¸ºä¾‹ç”Ÿæˆç‰¹å®šç±»å‹çš„å¼‚å¸¸ã€‚</p>
<pre><code class="language-javascript">//core/http-exception.js
class HttpException extends Error {
  //msgä¸ºå¼‚å¸¸ä¿¡æ¯ï¼ŒerrorCodeä¸ºé”™è¯¯ç (å¼€å‘äººå‘˜å†…éƒ¨çº¦å®š),codeä¸ºHTTPçŠ¶æ€ç 
  constructor(msg='æœåŠ¡å™¨å¼‚å¸¸', errorCode=10000, code=400) {
    super()
    this.errorCode = errorCode
    this.code = code
    this.msg = msg
  }
}

module.exports = {
  HttpException
}
//app/api/user.js
const Router = require('koa-router')
const router = new Router()
const { HttpException } = require('../../core/http-exception')

router.post('/user', (ctx, next) =&gt; {
    if(true){
        const error = new HttpException('ç½‘ç»œè¯·æ±‚é”™è¯¯', 10001, 400)
        throw error
  }
})
</code></pre>
<p>è¿”å›çš„æ¥å£è¿™æ ·:</p>
<pre><code class="language-json">{
	&quot;msg&quot;: &quot;ç½‘ç»œè¯·æ±‚é”™è¯¯&quot;,
	&quot;error_code&quot;:10001,
	&quot;request&quot;: &quot;POST /user&quot;
}
</code></pre>
<p>è¿™æ ·å°±æŠ›å‡ºäº†ä¸€ä¸ªç‰¹å®šç±»å‹çš„é”™è¯¯ã€‚ä½†æ˜¯åœ¨ä¸šåŠ¡ä¸­é”™è¯¯çš„ç±»å‹æ˜¯éå¸¸å¤æ‚çš„ï¼Œç°åœ¨æˆ‘å°±æŠŠæˆ‘ç¼–å†™çš„ä¸€äº›Exceptionç±»åˆ†äº«ä¸€ä¸‹ï¼Œä¾›å¤§å®¶æ¥å‚è€ƒ:</p>
<pre><code class="language-javascript">// http-exception.js
class HttpException extends Error {
  constructor(msg = 'æœåŠ¡å™¨å¼‚å¸¸', errorCode=10000, code=400) {
    super()
    this.error_code = errorCode
    this.code = code
    this.msg = msg
  }
}

class ParameterException extends HttpException{
  constructor(msg, errorCode){
    super()
    this.code = 400
    this.msg = msg || 'å‚æ•°é”™è¯¯'
    this.errorCode = errorCode || 10000
  }
}

class NotFound extends HttpException{
  constructor(msg, errorCode) {
    super();
    this.msg = msg || 'èµ„æºæœªæ‰¾åˆ°';
    this.errorCode = errorCode || 10001;
    this.code = 404;
  }
}

class AuthFailed extends HttpException{
  constructor(msg, errorCode) {
    super();
    this.msg = msg || 'æˆæƒå¤±è´¥';
    this.errorCode = errorCode || 10002;
    this.code = 404;
  }
}

class Forbidden extends HttpException{
  constructor(msg, errorCode) {
    super();
    this.msg = msg || 'ç¦æ­¢è®¿é—®';
    this.errorCode = errorCode || 10003;
    this.code = 404;
  }
}

module.exports = {
  HttpException,
  ParameterException,
  Success,
  NotFound,
  AuthFailed,
  Forbidden
}
</code></pre>
<p>å¯¹äºè¿™ç§ç»å¸¸éœ€è¦è°ƒç”¨çš„é”™è¯¯å¤„ç†çš„ä»£ç ï¼Œæœ‰å¿…è¦å°†å®ƒæ”¾åˆ°å…¨å±€ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¯¼å…¥ã€‚</p>
<p>ç°åœ¨çš„init.jsä¸­æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-javascript">// init.js
const requireDirectory = require('require-directory');
const Router = require('koa-router');

class InitManager {
  static initCore(app) {
    //å…¥å£æ–¹æ³•
    InitManager.app = app;
    InitManager.initLoadRouters();
    InitManager.loadConfig();
    InitManager.loadHttpException();//åŠ å…¥å…¨å±€çš„Exception
  }
  static initLoadRouters() {
    // path config
    const apiDirectory = `${process.cwd()}/app/api/v1`;
    requireDirectory(module, apiDirectory, {
      visit: whenLoadModule
    });

    function whenLoadModule(obj) {
      if (obj instanceof Router) {
        InitManager.app.use(obj.routes());
      }
    }
  }
  static loadConfig(path = '') {
    const configPath = path || process.cwd() + '/config/config.js';
    const config = require(configPath);
    global.config = config;
  }
  static loadHttpException() {
    const errors = require('./http-exception');
    global.errs = errors;
  }
}

module.exports = InitManager;
</code></pre>
<h2 id="äº”ä½¿ç”¨jwtå®Œæˆè®¤è¯æˆæƒ">äº”.ä½¿ç”¨JWTå®Œæˆè®¤è¯æˆæƒ</h2>
<p>JWT(å³Json Web Token)ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸèº«ä»½éªŒè¯è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚å®ƒçš„å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<p>1.å‰ç«¯å‘åç«¯ä¼ é€’ç”¨æˆ·åå’Œå¯†ç </p>
<p>2.ç”¨æˆ·åå’Œå¯†ç åœ¨åç«¯æ ¸å®æˆåŠŸåï¼Œè¿”å›å‰ç«¯ä¸€ä¸ªtoken(æˆ–å­˜åœ¨cookieä¸­)</p>
<p>3.å‰ç«¯æ‹¿åˆ°tokenå¹¶è¿›è¡Œä¿å­˜</p>
<p>4.å‰ç«¯è®¿é—®åç«¯æ¥å£æ—¶å…ˆè¿›è¡Œtokenè®¤è¯ï¼Œè®¤è¯é€šè¿‡æ‰èƒ½è®¿é—®æ¥å£ã€‚</p>
<p>é‚£ä¹ˆåœ¨koaä¸­æˆ‘ä»¬éœ€è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ</p>
<p>åœ¨ç”Ÿæˆtokené˜¶æ®µï¼šé¦–å…ˆæ˜¯éªŒè¯è´¦æˆ·ï¼Œç„¶åç”Ÿæˆtokenä»¤ç‰Œï¼Œä¼ ç»™å‰ç«¯ã€‚</p>
<p>åœ¨è®¤è¯tokené˜¶æ®µ: å®Œæˆè®¤è¯ä¸­é—´ä»¶çš„ç¼–å†™ï¼Œå¯¹å‰ç«¯çš„è®¿é—®åšä¸€å±‚æ‹¦æˆªï¼Œtokenè®¤è¯è¿‡åæ‰èƒ½è®¿é—®åé¢çš„æ¥å£ã€‚</p>
<p><strong>1.ç”Ÿæˆtoken</strong><br>
å…ˆå®‰è£…ä¸¤ä¸ªåŒ…:</p>
<pre><code class="language-javascript">yarn add jsonwebtoken basic-auth
//config.js
module.exports = {
  environment: 'dev',
  database: {
    dbName: 'island',
    host: 'localhost',
    port: 3306,
    user: 'root',
    password: 'fjfj'
  },
  security: {
    secretKey: 'lajsdflsdjfljsdljfls',//ç”¨æ¥ç”Ÿæˆtokençš„keyå€¼
    expiresIn: 60 * 60//è¿‡æœŸæ—¶é—´
  }
}

//utils.js 
//ç”Ÿæˆtokenä»¤ç‰Œå‡½æ•°ï¼Œuidä¸ºç”¨æˆ·idï¼Œscopeä¸ºæƒé™ç­‰çº§(ç±»å‹ä¸ºæ•°å­—ï¼Œå†…éƒ¨çº¦å®š)
const generateToken = function(uid, scope){
    const { secretKey, expiresIn } = global.config.security
    //ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç”¨æˆ·ä¿¡æ¯çš„jså¯¹è±¡ï¼Œç¬¬äºŒä¸ªä¸ºç”¨æ¥ç”Ÿæˆtokençš„keyå€¼ï¼Œç¬¬ä¸‰ä¸ªä¸ºé…ç½®é¡¹
    const token = jwt.sign({
        uid,
        scope
    },secretKey,{
        expiresIn
    })
    return token
}
</code></pre>
<p><strong>2.Authä¸­é—´ä»¶å®ç°æ‹¦æˆª</strong></p>
<pre><code class="language-javascript">//å‰ç«¯ä¼ tokenæ–¹å¼
//åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸ŠAuthorization:`Basic ${base64(token+&quot;:&quot;)}`å³å¯
//å…¶ä¸­base64ä¸ºç¬¬ä¸‰æ–¹åº“js-base64å¯¼å‡ºçš„ä¸€ä¸ªæ–¹æ³•

//middlewares/auth.js
const basicAuth = require('basic-auth');
const jwt = require('jsonwebtoken');

class Auth {
  constructor(level) {
    Auth.USER = 8;
    Auth.ADMIN = 16;
    this.level = level || 1;
  }
  //æ³¨æ„è¿™é‡Œçš„mæ˜¯ä¸€ä¸ªå±æ€§
  get m() {
    return async (ctx, next) =&gt; {
      const userToken = basicAuth(ctx.req);
      let errMsg = 'tokenä¸åˆæ³•';

      if(!userToken || !userToken.name) {
        throw new global.errs.Forbidden();
      }
      try {
        //å°†å‰ç«¯ä¼ è¿‡æ¥çš„tokenå€¼è¿›è¡Œè®¤è¯ï¼Œå¦‚æœæˆåŠŸä¼šè¿”å›ä¸€ä¸ªdecodeå¯¹è±¡ï¼ŒåŒ…å«uidå’Œscope
        var decode = jwt.verify(userToken.name, global.config.security.secretKey);
      } catch (error) {
        // tokenä¸åˆæ³•
        // æˆ–tokenè¿‡æœŸ
        // æŠ›å¼‚å¸¸
        errMsg = '//æ ¹æ®æƒ…å†µå®šä¹‰'
        throw new global.errs.Forbidden(errMsg);
      }
      //å°†uidå’ŒscopeæŒ‚è½½ctxä¸­
      ctx.auth = {
        uid: decode.uid,
        scope: decode.scope
      };
      //ç°åœ¨èµ°åˆ°è¿™é‡Œtokenè®¤è¯é€šè¿‡
      await next();
    }
  }
}
module.exports = Auth;
</code></pre>
<p>åœ¨è·¯ç”±ç›¸åº”æ–‡ä»¶ä¸­ç¼–å†™å¦‚ä¸‹:</p>
<pre><code class="language-javascript">//ä¸­é—´ä»¶å…ˆè¡Œï¼Œå¦‚æœä¸­é—´ä»¶ä¸­è®¤è¯æœªé€šè¿‡ï¼Œåˆ™ä¸ä¼šèµ°åˆ°è·¯ç”±å¤„ç†é€»è¾‘è¿™é‡Œæ¥
router.post('/xxx', new Auth().m , async (ctx, next) =&gt; {
    //......
})
</code></pre>
<h2 id="å…­requireè·¯å¾„åˆ«å">å…­.requireè·¯å¾„åˆ«å</h2>
<p>åœ¨å¼€å‘çš„è¿‡ç¨‹ï¼Œå½“é¡¹ç›®çš„ç›®å½•è¶Šæ¥è¶Šå¤æ‚çš„æ—¶å€™ï¼ŒåŒ…çš„å¼•ç”¨è·¯å¾„ä¹Ÿå˜å¾—è¶Šæ¥è¶Šéº»çƒ¦ã€‚æ›¾ç»å°±å‡ºç°è¿‡è¿™æ ·çš„å¯¼å…¥è·¯å¾„:</p>
<pre><code class="language-javascript">const Favor = require('../../../models/favor');
</code></pre>
<p>ç”šè‡³è¿˜æœ‰æ¯”è¿™ä¸ªæ›´åŠ å†—é•¿çš„å¯¼å…¥æ–¹å¼ï¼Œä½œä¸ºä¸€ä¸ªæœ‰ä»£ç æ´ç™–çš„ç¨‹åºå‘˜ï¼Œå®åœ¨è®©äººçœ‹çš„éå¸¸ä¸çˆ½ã€‚å…¶å®é€šè¿‡ç»å¯¹è·¯å¾„process.cwd()çš„æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥è§£å†³è¿™æ ·ä¸€ä¸ªé—®é¢˜çš„ï¼Œä½†æ˜¯å½“ç›®å½•æ·±åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™ï¼Œå¯¼å…¥çš„ä»£ç ä¹Ÿéå¸¸ç¹å†—ã€‚é‚£æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹å¼å‘¢ï¼Ÿ</p>
<p>ä½¿ç”¨module-aliaså°†è·¯å¾„åˆ«åå°±å¯ä»¥ã€‚</p>
<pre><code class="language-javascript">yarn add module-alias
//package.jsonæ·»åŠ å¦‚ä¸‹å†…å®¹
  &quot;_moduleAliases&quot;: {
    &quot;@models&quot;: &quot;app/models&quot;
  },
</code></pre>
<p>ç„¶ååœ¨app.jså¼•å…¥è¿™ä¸ªåº“ï¼š</p>
<pre><code class="language-javascript">//å¼•å…¥å³å¯
require('module-alias/register');
</code></pre>
<p>ç°åœ¨å¼•å…¥ä»£ç å°±å˜æˆè¿™æ ·äº†:</p>
<pre><code class="language-javascript">const Favor = require('@models/favor');
</code></pre>
<p>ç®€æ´æ¸…æ™°äº†è®¸å¤šï¼Œä¹Ÿæ›´å®¹æ˜“è®©äººç»´æŠ¤ã€‚</p>
<h2 id="ä¸ƒåˆ©ç”¨sequelizeçš„äº‹åŠ¡è§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜">ä¸ƒ.åˆ©ç”¨sequelizeçš„äº‹åŠ¡è§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜</h2>
<p>å½“ä¸€ä¸ªä¸šåŠ¡è¦è¿›è¡Œå¤šé¡¹æ•°æ®åº“çš„æ“ä½œæ—¶ï¼Œæ‹¿ç‚¹èµåŠŸèƒ½ä¸ºä¾‹ï¼Œé¦–å…ˆä½ å¾—åœ¨ç‚¹èµè®°å½•çš„è¡¨ä¸­å¢åŠ è®°å½•ï¼Œç„¶åä½ è¦å°†å¯¹åº”å¯¹è±¡çš„ç‚¹èµæ•°åŠ 1ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¿…é¡»è¦ä¸€èµ·å®Œæˆçš„ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ“ä½œæˆåŠŸï¼Œå¦ä¸€ä¸ªæ“ä½œå‡ºç°äº†é—®é¢˜ï¼Œé‚£å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ›å¦‚æœå‡ºç°äº†ä»»ä½•é—®é¢˜ï¼Œç›´æ¥å›æ»šåˆ°æœªæ“ä½œä¹‹å‰çš„çŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™å»ºè®®ç”¨æ•°æ®åº“äº‹åŠ¡çš„æ“ä½œã€‚åˆ©ç”¨sequelizeçš„transactionæ˜¯å¯ä»¥å®Œæˆçš„ï¼ŒæŠŠä¸šåŠ¡éƒ¨åˆ†çš„ä»£ç è´´ä¸€ä¸‹:</p>
<pre><code class="language-javascript">async like(art_id, uid) {
    //æŸ¥æ‰¾æ˜¯å¦æœ‰é‡å¤çš„
    const favor = await Favor.findOne({
      where: { art_id, uid }
      }
    );
    //æœ‰é‡å¤åˆ™æŠ›å¼‚å¸¸
    if (favor) {
      throw new global.errs.LikeError('ä½ å·²ç»ç‚¹è¿‡èµäº†');
    }
    //dbä¸ºsequelizeçš„å®ä¾‹
    //ä¸‹é¢æ˜¯äº‹åŠ¡çš„æ“ä½œ
    return db.transaction(async t =&gt; {
      //1.åˆ›å»ºç‚¹èµè®°å½•
      await Favor.create({ art_id, uid }, { transaction: t });
      //2.å¢åŠ ç‚¹èµæ•°
      const art = await Art.getData(art_id, type);//æ‹¿åˆ°è¢«ç‚¹èµçš„å¯¹è±¡
      await art.increment('fav_nums', { by: 1, transaction: t });//åŠ 1æ“ä½œ
    });
  }
</code></pre>
<p>sequelizeä¸­çš„transactionå¤§æ¦‚å°±æ˜¯è¿™æ ·åšçš„ï¼Œå®˜æ–¹æ–‡æ¡£æ˜¯promiseçš„æ–¹å¼ï¼Œçœ‹èµ·æ¥å®åœ¨å¤ªä¸ç¾è§‚ï¼Œæ”¹æˆasync/awaitæ–¹å¼ä¼šå¥½å¾ˆå¤šï¼Œä½†æ˜¯åƒä¸‡ä¸è¦å¿˜äº†å†™awaitã€‚</p>
<p>å…³äºkoa2çš„ä»£ç ä¼˜åŒ–ï¼Œå°±å…ˆåˆ†äº«åˆ°è¿™é‡Œï¼Œæœªå®Œå¾…ç»­ï¼Œåç»­ä¼šä¸æ–­è¡¥å……ã€‚æ¬¢è¿ç‚¹èµã€ç•™è¨€!</p>

        </div>

        
          <a class="animated fadeInUp p-2 items-center text-sm text-gray-700 border hover:bg-gray-300 leading-none rounded-full flex lg:inline-flex m-4 " href="https://zu3zz.coding.me/tag/Zkk1cdrv0/">
            <span class="flex-auto">Koa</span>
          </a>
        
          <a class="animated fadeInUp p-2 items-center text-sm text-gray-700 border hover:bg-gray-300 leading-none rounded-full flex lg:inline-flex m-4 " href="https://zu3zz.coding.me/tag/2Iiv88cUt/">
            <span class="flex-auto">Node.js</span>
          </a>
        


        <div class="flex justify-between py-8">
          
            <div class="prev-post">
              <a href="https://zu3zz.coding.me/post/react-ssr/">
                <h3 class="post-title">
                  <i class="remixicon-arrow-left-line"></i>
                  ä»å¤´æ¢³ç†æœåŠ¡å™¨æ¸²æŸ“åŸç†(SSR)
                </h3>
              </a>
            </div>
          

          
            <div class="next-post">
              <a href="https://zu3zz.coding.me/post/react-jian-shu/">
                <h3 class="post-title">
                  è¿ˆå‡ºReactçš„ç¬¬ä¸€æ­¥
                  <i class="remixicon-arrow-right-line"></i>
                </h3>
              </a>
            </div>
          
        </div>

        

      </div>
    </div>

    <script src="https://zu3zz.coding.me/media/prism.js"></script>  
<script>

Prism.highlightAll()

let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

// This should probably be throttled.
// Especially because it triggers during smooth scrolling.
// https://lodash.com/docs/4.17.10#throttle
// You could do like...
// window.addEventListener("scroll", () => {
//    _.throttle(doThatStuff, 100);
// });
// Only not doing it here to keep this Pen dependency-free.

window.addEventListener("scroll", event => {
  let fromTop = window.scrollY;

  mainNavLinks.forEach((link, index) => {
    let section = document.getElementById(decodeURI(link.hash).substring(1));
    let nextSection = null
    if (mainNavLinks[index + 1]) {
      nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
    }
    if (section.offsetTop <= fromTop) {
      if (nextSection) {
        if (nextSection.offsetTop > fromTop) {
          link.classList.add("current");
        } else {
          link.classList.remove("current");    
        }
      } else {
        link.classList.add("current");
      }
    } else {
      link.classList.remove("current");
    }
  });
});


document.addEventListener("DOMContentLoaded", function() {
  var lazyImages = [].slice.call(document.querySelectorAll(".post-feature-image.lazy"));

  if ("IntersectionObserver" in window) {
    let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          let lazyImage = entry.target
          lazyImage.style.backgroundImage = `url(${lazyImage.dataset.bg})`
          lazyImage.classList.remove("lazy")
          lazyImageObserver.unobserve(lazyImage)
        }
      });
    });

    lazyImages.forEach(function(lazyImage) {
      lazyImageObserver.observe(lazyImage)
    })
  } else {
    // Possibly fall back to a more compatible method here
  }
});

const menuContainer = document.querySelector('.menu-container')
const menus = document.querySelectorAll('.menu-container .menu')
const mask = document.querySelector('.mask')
const contentWrapper = document.querySelector('.content-wrapper')
const latestArticle = document.querySelector('.latest-article')
const readMore = document.querySelector('.read-more')
const indexPage = document.querySelector('.index-page')

const isHome = location.pathname === '/'
if (latestArticle) {
  latestArticle.style.display = isHome ? 'block' : 'none'
  readMore.style.display = isHome ? 'block' : 'none'
  indexPage.style.display = isHome ? 'none' : 'block'
}

const openMenu = () => {
  menuContainer.classList.add('open')
  menus.forEach(menu => {
    menu.classList.add('animated', 'fadeInLeft')
  })
  mask.classList.add('open')
  contentWrapper.classList.add('is-second')
}

const closeMenu = () => {
  menuContainer.classList.remove('open')
  menus.forEach(menu => {
    menu.classList.remove('animated', 'fadeInLeft')
  })
  mask.classList.remove('open')
  contentWrapper.classList.remove('is-second')
}
</script>
  
  </body>
</html>
